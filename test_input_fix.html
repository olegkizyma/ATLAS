<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –ø–æ–ª—è –≤–≤–æ–¥—É Atlas</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #000; color: #00ff41; }
        button { margin: 5px; padding: 10px; background: #003300; color: #00ff41; border: 1px solid #00ff41; }
        #log { margin-top: 20px; padding: 10px; border: 1px solid #00ff41; height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>–¢–µ—Å—Ç –ø–æ–ª—è –≤–≤–æ–¥—É Atlas</h1>
    
    <button onclick="testConnection()">–¢–µ—Å—Ç –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è</button>
    <button onclick="sendTestMessage()">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ —Ç–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</button>
    <button onclick="checkInputState()">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞–Ω –ø–æ–ª—è –≤–≤–æ–¥—É</button>
    <button onclick="forceUnlock()">–ü—Ä–∏–º—É—Å–æ–≤–µ —Ä–æ–∑–±–ª–æ–∫—É–≤–∞–Ω–Ω—è (Ctrl+Shift+U)</button>
    
    <div id="log"></div>
    
    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        async function testConnection() {
            try {
                const response = await fetch('http://localhost:8080/api/status');
                if (response.ok) {
                    const data = await response.json();
                    log('‚úÖ –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Atlas —É—Å–ø—ñ—à–Ω–µ');
                    log(`üìä –°—Ç–∞—Ç—É—Å: ${JSON.stringify(data, null, 2)}`);
                } else {
                    log('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Atlas');
                }
            } catch (error) {
                log(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`);
            }
        }
        
        async function sendTestMessage() {
            const testMessage = '–¢–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –ø–æ–ª—è –≤–≤–æ–¥—É';
            log(`üì§ –í—ñ–¥–ø—Ä–∞–≤–ª—è—é —Ç–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: "${testMessage}"`);
            
            try {
                const response = await fetch('http://localhost:8080/api/chat/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: testMessage })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let buffer = '';
                
                log('üì° –û—Ç—Ä–∏–º—É—é –≤—ñ–¥–ø–æ–≤—ñ–¥—å —Å—Ç—Ä—ñ–º–æ–º...');
                
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\\n');
                    buffer = lines.pop();
                    
                    for (const line of lines) {
                        if (line.trim().startsWith('data:')) {
                            const data = line.slice(5).trim();
                            try {
                                const obj = JSON.parse(data);
                                log(`üì® –û—Ç—Ä–∏–º–∞–Ω–æ: ${JSON.stringify(obj)}`);
                            } catch {
                                log(`üì® –û—Ç—Ä–∏–º–∞–Ω–æ —Ç–µ–∫—Å—Ç: ${data}`);
                            }
                        }
                    }
                }
                
                log('‚úÖ –°—Ç—Ä—ñ–º –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
                
            } catch (error) {
                log(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`);
            }
        }
        
        function checkInputState() {
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞–Ω –ø–æ–ª—è –≤–≤–æ–¥—É –≤ –æ—Å–Ω–æ–≤–Ω–æ–º—É –≤—ñ–∫–Ω—ñ
            const mainWindow = window.parent || window;
            if (mainWindow.atlasInterface) {
                const iface = mainWindow.atlasInterface;
                const input = mainWindow.document.getElementById('chatInput');
                
                log(`üîç –°—Ç–∞–Ω —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É:`);
                log(`  - isStreaming: ${iface.isStreaming}`);
                log(`  - isStreamPending: ${iface.isStreamPending}`);
                log(`  - input.disabled: ${input ? input.disabled : 'not found'}`);
                log(`  - _autoBlockedBySessions: ${iface._autoBlockedBySessions}`);
            } else {
                log('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ atlasInterface');
            }
        }
        
        function forceUnlock() {
            const mainWindow = window.parent || window;
            if (mainWindow.atlasInterface) {
                const iface = mainWindow.atlasInterface;
                const input = mainWindow.document.getElementById('chatInput');
                
                iface.isStreaming = false;
                iface.isStreamPending = false;
                iface._autoBlockedBySessions = false;
                
                if (input) {
                    input.disabled = false;
                    log('üîì –ü–æ–ª–µ –≤–≤–æ–¥—É –ø—Ä–∏–º—É—Å–æ–≤–æ —Ä–æ–∑–±–ª–æ–∫–æ–≤–∞–Ω–æ');
                } else {
                    log('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ –ø–æ–ª–µ –≤–≤–æ–¥—É');
                }
            } else {
                log('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ atlasInterface');
            }
        }
        
        log('üöÄ –¢–µ—Å—Ç–æ–≤–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞');
    </script>
</body>
</html>
