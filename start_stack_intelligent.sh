#!/bin/bash

# ATLAS Intelligent Startup Script
# –ü–æ–≤–Ω—ñ—Å—Ç—é —ñ–Ω—Ç–µ–ª—ñ–≥–µ–Ω—Ç–Ω–∏–π –∑–∞–ø—É—Å–∫ –∑ –∞–¥–∞–ø—Ç–∏–≤–Ω–∏–º–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è–º–∏
# –ó–∞–º—ñ–Ω—é—î start_stack_macos.sh –∑ —ñ–Ω—Ç–µ–ª—ñ–≥–µ–Ω—Ç–Ω–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏

set -e

echo "üß† ATLAS Intelligent Multi-Agent System"
echo "üöÄ Starting Intelligent Stack..."

# –ó–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ –¥–ª—è intelligent —Ä–µ–∂–∏–º—É
export ATLAS_INTELLIGENT_MODE=true
export ATLAS_AUTO_ADAPT=true
export ATLAS_LEARNING_ENABLED=true

# –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º: —Ä–µ–∞–ª—å–Ω–∏–π TTS —ñ MPS –Ω–∞ macOS (Apple Silicon)
: "${REAL_TTS_MODE:=true}"
: "${TTS_DEVICE:=mps}"

# Whisper STT GPU/Metal (Apple Silicon) ‚Äî –±–µ–∑–ø–µ—á–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
export WHISPER_DEVICE=${WHISPER_DEVICE:-auto}
export WHISPER_COMPUTE_TYPE=${WHISPER_COMPUTE_TYPE:-int8}

echo "üé§ TTS Mode: ${REAL_TTS_MODE} (Device: ${TTS_DEVICE})"
echo "üß† Intelligent Mode: ${ATLAS_INTELLIGENT_MODE}"

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–ø—É—Å–∫—É intelligent configuration migrator
run_intelligent_migration() {
    echo "üîß Running intelligent configuration migration..."
    cd frontend_new
    
    if [ -f "venv/bin/activate" ]; then
        source venv/bin/activate
    fi
    
    # –ó–∞–ø—É—Å–∫–∞—î–º–æ –º—ñ–≥—Ä–∞—Ü—ñ—é –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π
    python config/configuration_migrator.py --target all
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ Intelligent configuration migration completed"
    else
        echo "‚ö†Ô∏è  Migration failed, continuing with standard configuration"
    fi
    
    cd ..
}

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è intelligent health check
intelligent_health_check() {
    local service_name=$1
    local url=$2
    local pidfile=$3
    
    if [ -f "$pidfile" ] && ps -p $(cat $pidfile) > /dev/null 2>&1; then
        if curl -s --max-time 3 "$url" > /dev/null 2>&1; then
            echo "‚úÖ $service_name is running and responsive (intelligent mode)"
            
            # –î–æ–¥–∞—Ç–∫–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ intelligent features
            if [ "$service_name" = "Node.js Orchestrator" ]; then
                local intelligence_check=$(curl -s --max-time 2 "$url/health" 2>/dev/null | grep -i "intelligent" || echo "")
                if [ -n "$intelligence_check" ]; then
                    echo "üß† $service_name: Intelligent features active"
                else
                    echo "‚ö†Ô∏è  $service_name: Standard mode (consider enabling intelligent features)"
                fi
            fi
        else
            echo "‚ö†Ô∏è  $service_name is running but not responding"
        fi
    else
        echo "‚ùå $service_name is not running"
    fi
}

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó –¥–ª—è –ª–æ–≥—ñ–≤
mkdir -p logs

# 1. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Python Environment –∑ intelligent —Å–∏—Å—Ç–µ–º–∞–º–∏
echo "üêç Setting up Python environment with intelligent systems..."
cd frontend_new
if [ -f "venv/bin/activate" ]; then
    echo "üêç Activating virtual environment..."
    source venv/bin/activate
    echo "‚úÖ Virtual environment activated"
    
    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π –¥–ª—è intelligent —Å–∏—Å—Ç–µ–º
    if ! python -c "import sys; sys.path.append('config'); import intelligent_config" 2>/dev/null; then
        echo "üì¶ Installing intelligent system dependencies..."
        pip install -r requirements.txt
        echo "‚úÖ Intelligent dependencies installed"
    else
        echo "‚úÖ Intelligent systems already available"
    fi
else
    echo "‚ö†Ô∏è  Virtual environment not found, creating one..."
    python3 -m venv venv
    source venv/bin/activate
    pip install -r requirements.txt
    echo "‚úÖ Virtual environment created with intelligent systems"
fi
cd ..

# 2. –ó–∞–ø—É—Å–∫ intelligent configuration migration
run_intelligent_migration

# 3. Intelligent port management
echo "üîç Intelligent port management..."

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è intelligent port checking
intelligent_port_check() {
    local port=$1
    local service_name=$2
    
    if lsof -ti:$port > /dev/null 2>&1; then
        local pid=$(lsof -ti:$port)
        local process_name=$(ps -p $pid -o comm= 2>/dev/null || echo "unknown")
        
        echo "‚ÑπÔ∏è  Port $port busy by $process_name (PID: $pid)"
        
        # Intelligent decision making
        if echo "$process_name" | grep -qi "$service_name"; then
            echo "‚úÖ $service_name already running on port $port"
            return 0
        elif [ "${ATLAS_AUTO_RESTART:-false}" = "true" ]; then
            echo "üîÑ Auto-restarting service on port $port..."
            kill $pid 2>/dev/null || true
            sleep 2
            return 1
        else
            echo "‚ö†Ô∏è  Port $port busy by different service"
            return 1
        fi
    else
        echo "‚úÖ Port $port available for $service_name"
        return 0
    fi
}

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–æ—Ä—Ç—ñ–≤ –∑ intelligent logic
intelligent_port_check 3000 "goose"
intelligent_port_check 3001 "tts"
intelligent_port_check 5001 "frontend"
intelligent_port_check 5101 "orchestrator"
intelligent_port_check 5102 "recovery"

# 4. –ó–∞–ø—É—Å–∫ TTS –∑ intelligent –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è–º–∏
if [ "${REAL_TTS_MODE:-true}" = "true" ]; then
    echo "üé§ Starting REAL Ukrainian TTS with intelligent device selection..."
    if ! lsof -ti:3001 > /dev/null 2>&1; then
        (
            cd ukrainian-tts
            # Intelligent TTS device selection
            if [ "$(uname -m)" = "arm64" ]; then
                TTS_DEVICE=${TTS_DEVICE:-mps}  # Apple Silicon
            else
                TTS_DEVICE=${TTS_DEVICE:-cpu}  # Intel
            fi
            
            if [ -f ".venv/bin/activate" ]; then
                source .venv/bin/activate
            elif [ -f "venv/bin/activate" ]; then
                source venv/bin/activate
            fi
            
            python tts_server.py --host 127.0.0.1 --port 3001 --device "$TTS_DEVICE" > ../logs/tts_real.log 2>&1 &
            echo $! > ../logs/tts_real.pid
            echo "‚úÖ REAL TTS started with intelligent device: $TTS_DEVICE (PID: $(cat ../logs/tts_real.pid))"
        )
    fi
else
    echo "üé§ Starting Ukrainian TTS Mock with intelligent fallback..."
    if ! lsof -ti:3001 > /dev/null 2>&1; then
        cd frontend_new
        source venv/bin/activate
        TTS_PORT=3001 python ukrainian_tts_server.py > ../logs/tts_mock.log 2>&1 &
        echo $! > ../logs/tts_mock.pid
        echo "‚úÖ TTS mock started (PID: $(cat ../logs/tts_mock.pid))"
        cd ..
    fi
fi

# 5. –ó–∞–ø—É—Å–∫ Recovery Bridge (–æ–±–æ–≤'—è–∑–∫–æ–≤–æ –¥–ª—è intelligent mode)
echo "üîß Starting Intelligent Recovery Bridge..."
cd frontend_new
source venv/bin/activate
if ! lsof -ti:5102 > /dev/null 2>&1; then
    python config/recovery_bridge.py > ../logs/recovery_bridge.log 2>&1 &
    echo $! > ../logs/recovery_bridge.pid
    echo "‚úÖ Intelligent Recovery Bridge started (PID: $(cat ../logs/recovery_bridge.pid))"
else
    echo "‚ÑπÔ∏è  Recovery Bridge already running"
fi
cd ..

# –û—á—ñ–∫—É–≤–∞–Ω–Ω—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó Recovery Bridge
sleep 3

# 6. –ó–∞–ø—É—Å–∫ Intelligent Node.js Orchestrator
echo "üé≠ Starting Intelligent Node.js Orchestrator..."
cd frontend_new/orchestrator

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Node.js –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
if [ ! -d "node_modules" ]; then
    echo "üì¶ Installing Node.js dependencies..."
    npm install
fi

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ intelligent wrapper
if [ ! -f "intelligent_server_wrapper.js" ]; then
    echo "‚ö†Ô∏è  Intelligent wrapper not found, using standard server"
    node_command="node server.js"
else
    echo "üß† Using intelligent server wrapper"
    node_command="node intelligent_server_wrapper.js"
fi

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è intelligent environment
export ORCH_INTELLIGENT_MODE=true
export ORCH_AUTO_ADAPT=true
export ORCH_LEARNING_ENABLED=true
export ORCH_PORT=5101

# –°–ø—Ä–æ–±–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ intelligent –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é
if [ -f ".env.intelligent" ]; then
    echo "üß† Loading intelligent configuration..."
    # Node.js wrapper –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç—å .env.intelligent
else
    echo "üìã Using standard configuration (intelligent features may be limited)"
fi

# –ó–∞–ø—É—Å–∫ –∑ intelligent wrapper –∞–±–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
if ! lsof -ti:5101 > /dev/null 2>&1; then
    $node_command >> ../../logs/orchestrator.log 2>&1 &
    echo $! > ../../logs/orchestrator.pid
    echo "‚úÖ Intelligent orchestrator started (PID: $(cat ../../logs/orchestrator.pid))"
else
    echo "‚ÑπÔ∏è  Orchestrator already running"
fi
cd ../..

# 7. –ó–∞–ø—É—Å–∫ Intelligent Python Frontend
echo "üß† Starting Intelligent Python Frontend..."
cd frontend_new
source venv/bin/activate

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è intelligent frontend environment
export ATLAS_INTELLIGENT_MODE=true
export ATLAS_FRONTEND_ADAPTIVE=true
export ATLAS_TTS_URL=${ATLAS_TTS_URL:-http://127.0.0.1:3001/tts}

if ! lsof -ti:5001 > /dev/null 2>&1; then
    python app/atlas_server.py > ../logs/frontend.log 2>&1 &
    echo $! > ../logs/frontend.pid
    echo "‚úÖ Intelligent frontend started (PID: $(cat ../logs/frontend.pid))"
else
    echo "‚ÑπÔ∏è  Frontend already running"
fi
cd ..

# 8. Intelligent service health monitoring
echo "‚è≥ Waiting for intelligent systems to initialize..."
sleep 7

echo "üîç Running intelligent health checks..."

intelligent_health_check "Python Frontend" "http://localhost:5001" "logs/frontend.pid"
intelligent_health_check "Node.js Orchestrator" "http://localhost:5101/health" "logs/orchestrator.pid"
intelligent_health_check "Recovery Bridge" "ws://localhost:5102" "logs/recovery_bridge.pid"

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ intelligent features
echo ""
echo "üß† Intelligent Features Status:"

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ intelligent config files
if [ -f "frontend_new/orchestrator/.env.intelligent" ]; then
    echo "‚úÖ Intelligent orchestrator configuration: Active"
else
    echo "‚ö†Ô∏è  Intelligent orchestrator configuration: Not found (run migration)"
fi

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Recovery Bridge connection
if [ -f "logs/recovery_bridge.pid" ] && ps -p $(cat logs/recovery_bridge.pid) > /dev/null 2>&1; then
    echo "‚úÖ Intelligent Recovery System: Active"
else
    echo "‚ùå Intelligent Recovery System: Failed"
fi

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ adaptive behavior
if curl -s --max-time 2 "http://localhost:5101/health" 2>/dev/null | grep -qi "intelligent"; then
    echo "‚úÖ Adaptive Orchestrator Behavior: Active"
else
    echo "‚ö†Ô∏è  Adaptive Orchestrator Behavior: Standard mode"
fi

echo ""
echo "üéâ ATLAS Intelligent System Startup Complete!"
echo ""
echo "üìä Intelligent Service Dashboard:"
echo "   üß† Python Frontend:     http://localhost:5001 (with intelligent chat)"
echo "   üé≠ Orchestrator API:    http://localhost:5101 (intelligent mode)"
echo "   üîß Recovery Bridge:     ws://localhost:5102 (adaptive recovery)"
echo "   üé§ TTS API:             http://localhost:3001 (intelligent device selection)"
echo ""
echo "üìù Intelligent Logs:"
echo "   Frontend:        logs/frontend.log"
echo "   Orchestrator:    logs/orchestrator.log"
echo "   Recovery Bridge: logs/recovery_bridge.log"
echo ""
echo "üõ†Ô∏è  Intelligent Management:"
echo "   Stop system:     ./stop_stack.sh"
echo "   View logs:       tail -f logs/*.log"
echo "   Check status:    ./status_stack.sh"
echo "   Run migration:   cd frontend_new && python config/configuration_migrator.py"
echo ""
echo "üß† ATLAS Intelligent Mode is now active!"
echo "   The system will adaptively optimize performance,"
echo "   learn from failures, and automatically adjust"
echo "   configuration based on usage patterns."
echo ""
echo "üí° Access the intelligent interface at: http://localhost:5001"
