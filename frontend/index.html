<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas Minimal Interface</title>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000000;
            color: #00ff41;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        /* 3D Viewer Background Layer */
        .background-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        model-viewer {
            width: 100%;
            height: 100%;
            background-color: #000000;
            opacity: 0.3;
        }

        /* Interface Overlay Layer */
        .interface-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        /* Left Panel - MCP Logs */
        .logs-panel {
            position: absolute;
            left: 0;
            top: 0;
            width: 30%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            padding: 8px; /* —Ä—ñ–≤–Ω–æ–º—ñ—Ä–Ω–æ; —Ç–µ–∫—Å—Ç –≤—ñ–¥—Å—Ç—É–ø–∏–º–æ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
            pointer-events: auto;
            border-right: none; /* –±–µ–∑ –ª—ñ–Ω—ñ—ó */
        }

        .logs-container {
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 12px; /* —Ç—Ä–æ—Ö–∏ –º–µ–Ω—à–µ, –±–æ —Å–∫—Ä–æ–ª —Å—Ö–æ–≤–∞–Ω–∏–π */
            /* scrollbar-width: none;  (Removed for broader compatibility) */
            -ms-overflow-style: none; /* IE / —Å—Ç–∞—Ä–∏–π Edge */
        }

        .logs-container::-webkit-scrollbar {
            width: 0;
            height: 0;
        }

        .log-line {
            color: #4a9c5a;
            margin: 0;
            padding: 2px 0 1px 0; /* —Ç—Ä–æ—Ö–∏ –±—ñ–ª—å—à–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ –≤—ñ–¥—Å—Ç—É–ø—É –¥–ª—è –±—ñ–ª—å—à–æ–≥–æ —à—Ä–∏—Ñ—Ç—É */
            word-wrap: break-word;
            font-size: 11px; /* –±—É–ª–æ 10px */
            line-height: 1.28; /* –ø—ñ–¥–ª–∞—à—Ç–æ–≤–∞–Ω–æ –¥–ª—è —á–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—ñ */
            font-family: 'Courier New', monospace;
            font-weight: normal; /* –Ω–µ –∂–∏—Ä–Ω–∏–π —à—Ä–∏—Ñ—Ç */
            white-space: pre-wrap;
            letter-spacing: 0.3px; /* –ª–µ–≥–∫–µ —Ä–æ–∑—Ä—ñ–¥–∂–µ–Ω–Ω—è –¥–ª—è —Ö–∞–∫–µ—Ä—Å—å–∫–æ–≥–æ –≤–∏–≥–ª—è–¥—É */
        }

        .log-line.error {
            color: #d16969;
        }

        .log-line.warning {
            color: #d19a66;
        }

        .log-line.info {
            color: #5c9e5c;
        }

        .log-line.debug {
            color: #4a7a5a;
            opacity: 0.7;
        }

        /* Right Panel - Chat */
        .chat-panel {
            position: absolute;
            right: 0;
            top: 0;
            width: 50%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            padding: 8px;
            pointer-events: auto;
            border-left: 1px solid rgba(0, 255, 65, 0.1);
            display: flex;
            flex-direction: column;
        }

        /* Status Panel - System Status */
        .status-panel {
            position: absolute;
            left: 30%;
            top: 0;
            width: 20%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            padding: 8px;
            pointer-events: auto;
            font-size: 10px;
            border-left: 1px solid rgba(0, 255, 65, 0.1);
        }

        .status-container {
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 8px;
        }

        .status-section {
            margin-bottom: 12px;
            border-bottom: 1px solid rgba(0, 255, 65, 0.2);
            padding-bottom: 6px;
        }

        .status-title {
            color: #00ff41;
            font-weight: bold;
            font-size: 11px;
            margin-bottom: 4px;
        }

        .status-item {
            color: #00ff41;
            margin: 1px 0;
            font-size: 9px;
            opacity: 0.8;
        }

        .status-item.online {
            color: #00ff41;
        }

        .status-item.warning {
            color: #ffff41;
        }

        .status-item.error {
            color: #ff4141;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 4px;
            margin-bottom: 8px;
        }

        .message {
            margin-bottom: 6px;
            padding: 4px 6px;
            border: 1px solid rgba(0, 255, 65, 0.1);
            border-radius: 2px;
            background: rgba(0, 0, 0, 0.2);
        }

        .message.user {
            border-color: rgba(0, 255, 65, 0.3);
            text-align: right;
        }

        .message.assistant {
            border-color: rgba(0, 255, 65, 0.2);
        }

        .message-text {
            color: #00ff41;
            font-size: 11px;
            line-height: 1.3;
        }

        .message-time {
            color: #006622;
            font-size: 9px;
            margin-top: 2px;
        }

        /* Badges */
        .badge {
            display: inline-block;
            margin-left: 6px;
            font-size: 9px;
            padding: 1px 4px;
            border-radius: 3px;
            border: 1px solid rgba(0, 255, 65, 0.3);
        }
        .badge.queued {
            color: #ffff41;
            border-color: rgba(255, 255, 65, 0.5);
        }

        /* Chat Input Area */
        .chat-input-area {
            display: flex;
            gap: 6px;
            align-items: flex-end;
            position: relative;
        }



        .chat-input {
            flex: 1;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(0, 255, 65, 0.2);
            color: #00ff41;
            padding: 6px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            resize: none;
            min-height: 20px;
            max-height: 60px;
        }

        .chat-input:focus {
            outline: none;
            border-color: rgba(0, 255, 65, 0.4);
        }

        .voice-button {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(0, 255, 65, 0.2);
            color: #00ff41;
            padding: 6px 8px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            transition: all 0.2s;
        }

        .voice-button:hover {
            border-color: rgba(0, 255, 65, 0.4);
            background: rgba(0, 255, 65, 0.1);
        }

        .voice-button.listening {
            background: rgba(0, 255, 65, 0.2);
            border-color: rgba(0, 255, 65, 0.6);
        }

        .voice-button.continuous {
            background: rgba(255, 255, 65, 0.2);
            border-color: rgba(255, 255, 65, 0.6);
            color: #ffff41;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 65, 0.3);
            border-radius: 2px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 65, 0.5);
        }
    </style>
</head>
<body>
    <!-- Background 3D Layer -->
    <div class="background-layer">
        <model-viewer 
            src="DamagedHelmet.glb" 
            alt="Atlas 3D Interface"
            auto-rotate 
            camera-controls 
            environment-image="neutral"
            exposure="0.1"
            shadow-intensity="0.02"
            tone-mapping="neutral">
        </model-viewer>
    </div>

    <!-- Interface Overlay -->
    <div class="interface-layer">
        <!-- Left Panel - MCP Logs -->
        <div class="logs-panel">
            <div class="logs-container" id="logsContainer">
                <div class="log-line debug">[05:21:07] [ATLAS] System initializing...</div>
                <div class="log-line debug">[05:21:09] [TTS] Service ready</div>
                <div class="log-line debug">[05:21:10] [AUTO] Automation ready</div>
                <div class="log-line debug">[05:21:11] [NET] Ports listening</div>
            </div>
        </div>

        <!-- Status Panel - System Status -->
        <div class="status-panel">
            <div class="status-container" id="statusContainer">
                <div class="status-section">
                    <div class="status-title">PROCESSES</div>
                    <div id="processStatus">
                        <div class="status-item">Atlas: 0</div>
                        <div class="status-item">Atlas Core: 0</div>
                        <div class="status-item">MCP: 0</div>
                    </div>
                </div>
                
                <div class="status-section">
                    <div class="status-title">SERVICES</div>
                    <div id="serviceStatus">
                        <div class="status-item">Core: offline</div>
                        <div class="status-item">MCP: offline</div>
                    </div>
                </div>
                
                <div class="status-section">
                    <div class="status-title">NETWORK</div>
                    <div id="networkStatus">
                        <div class="status-item">Connections: 0</div>
                    </div>
                </div>
                
                <div class="status-section">
                    <div class="status-title">RESOURCES</div>
                    <div id="resourceStatus">
                        <div class="status-item">CPU: --</div>
                        <div class="status-item">Disk: --</div>
                    </div>
                </div>
                
                <div class="status-section">
                    <div class="status-title">ATLAS INTELLIGENCE</div>
                    <div id="atlasIntelligenceStatus">
                        <div class="status-item">Auto-corrections: --</div>
                        <div class="status-item">Grisha verifications: --</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel - Chat -->
        <div class="chat-panel">
            <div class="chat-messages" id="chatMessages">
                <div class="message assistant">
                    <div class="message-text">Atlas Minimal Interface –∞–∫—Ç–∏–≤–Ω–∏–π</div>
                    <div class="message-time">00:00:01</div>
                </div>
            </div>
            
            <div class="chat-input-area">
                <textarea 
                    id="chatInput" 
                    class="chat-input" 
                    placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..."
                    rows="1"></textarea>
                <button id="voiceButton" class="voice-button">üé§</button>
            </div>
        </div>
    </div>

    <script>
    // –í–∏–∑–Ω–∞—á–∞—î–º–æ API –±–∞–∑—É –¥–∏–Ω–∞–º—ñ—á–Ω–æ, —â–æ–± —É–Ω–∏–∫–∞—Ç–∏ 404 –ø—Ä–∏ –∑–º—ñ–Ω—ñ –ø–æ—Ä—Ç—É
    window.ATLAS_API_BASE = window.location.origin;
    class AtlasMinimalInterface {
            constructor() {
                this.voiceMode = 'off'; // 'off', 'single', 'continuous'
                this.recognition = null;
                this.isListening = false;
                // –ö–µ—Ä—É–≤–∞–Ω–Ω—è –ø–æ—Ä—è–¥–∫–æ–º –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å/—Å—Ç—Ä—ñ–º—ñ–≤
                this.isStreaming = false;      // –∞–∫—Ç–∏–≤–Ω–∏–π —Å—Ç—Ä—ñ–º –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
                // –ù–æ–≤–∏–π —Ñ–ª–∞–≥: –∑–∞–ø–∏—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ, –∞–ª–µ –ø–µ—Ä—à–∏–π SSE-—á—É–Ω–∫ —â–µ –Ω–µ –ø—Ä–∏–π—à–æ–≤
                this.isStreamPending = false;  // –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø–æ—á–∞—Ç–∫—É —Å—Ç—Ä—ñ–º—É
                this.messageQueue = [];        // —á–µ—Ä–≥–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
                this.clickCount = 0;
                this.clickTimer = null;
                this.singleModeSendTimer = null; // —Ç–∞–π–º–µ—Ä –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è 3s —É single —Ä–µ–∂–∏–º—ñ
                this.lastFinalTimestamp = 0;
                this.TTSBlockTimer = null; // –ø–∞—É–∑–∞ –¥–ª—è continuous –ø—ñ–¥ —á–∞—Å "–º–æ–≤–ª–µ–Ω–Ω—è"
                this.TTS_ACTIVE = false;
                
                // –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Å–µ—Å—ñ—è–º–∏
                this.sessionMode = 'auto'; // 'auto', 'new', 'continue'
                this.currentSessionName = null;
                this.TTSBlockTimer = null; // –ø–∞—É–∑–∞ –¥–ª—è continuous –ø—ñ–¥ —á–∞—Å "–º–æ–≤–ª–µ–Ω–Ω—è"
                this.TTS_ACTIVE = false;
                this.SINGLE_INACTIVITY_MS = 3000; // 3s –ø—ñ—Å–ª—è –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ —Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
                this.MIN_FINAL_CHARS_TO_SEND = 2;
                // –ê–≤—Ç–æ–≤—ñ–¥–ø–æ–≤—ñ–¥—å (–∫–æ–ª–∏ Goose –ø–∏—Ç–∞—î –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è)
                this.autoReplyTimer = null;
                this.autoReplyActive = false;
                // –ê–≤—Ç–æ–±–ª–æ–∫ –∫–µ—Ä—É–≤–∞–Ω–Ω—è: –≥—Ä–µ–π—Å-–ø–µ—Ä—ñ–æ–¥ –ø—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –≤–ª–∞—Å–Ω–æ–≥–æ —Å—Ç—Ä—ñ–º—É, —â–æ–± —Å—Ç–∞—Ç—É—Å-–ø–æ–ª–ª –Ω–µ —Ä–µ–±–ª–æ–∫–∞–≤
                this._autoBlockedBySessions = false;
                this._lastStreamFinishedAt = 0;
                this._autoBlockGraceUntil = 0;
                // –ü—Ä–æ—Å—Ç—ñ—à–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –±–µ–∑ –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –∫–Ω–æ–ø–æ–∫
                
                this.initializeElements();
                this.initializeVoiceRecognition();
                this.startMCPLogging();
                this.startStatusMonitoring();
                this.bindEvents();
            }

            initializeElements() {
                this.chatInput = document.getElementById('chatInput');
                this.chatMessages = document.getElementById('chatMessages');
                this.voiceButton = document.getElementById('voiceButton');
                this.logsContainer = document.getElementById('logsContainer');
                this.statusContainer = document.getElementById('statusContainer');
                this.processStatus = document.getElementById('processStatus');
                this.serviceStatus = document.getElementById('serviceStatus');
                this.networkStatus = document.getElementById('networkStatus');
                this.resourceStatus = document.getElementById('resourceStatus');
            }



            initializeVoiceRecognition() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ continuous=true, –∞–ª–µ –∫–µ—Ä—É—î–º–æ –∞–≤—Ç–æ–ø–∞—É–∑–∞ / —Ä–µ—Å—Ç–∞—Ä—Ç –≤—Ä—É—á–Ω—É
                    this.recognition.continuous = true;
                    this.recognition.interimResults = true;
                    this.recognition.lang = 'uk-UA';

                    this.recognition.onresult = (event) => {
                        let aggregatedFinal = '';
                        let aggregatedInterim = '';
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            const res = event.results[i];
                            if (res.isFinal) {
                                aggregatedFinal += res[0].transcript;
                            } else {
                                aggregatedInterim += res[0].transcript;
                            }
                        }
                        // –û–Ω–æ–≤–ª—é—î–º–æ textarea (—Ñ—ñ–Ω–∞–ª—å–Ω–∏–π + –ø–æ—Ç–æ—á–Ω–∏–π —ñ–Ω—Ç–µ—Ä—ñ–º)
                        this.chatInput.value = (aggregatedFinal + aggregatedInterim).trim();

                        if (aggregatedFinal) {
                            this.lastFinalTimestamp = Date.now();
                            // SINGLE MODE: —Å—Ç–≤–æ—Ä—é—î–º–æ / –ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ —Ç–∞–π–º–µ—Ä 3s –ø—ñ—Å–ª—è –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ —Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞
                            if (this.voiceMode === 'single') {
                                if (this.singleModeSendTimer) {
                                    clearTimeout(this.singleModeSendTimer);
                                }
                                if ((aggregatedFinal.trim().length) >= this.MIN_FINAL_CHARS_TO_SEND) {
                                    this.singleModeSendTimer = setTimeout(() => {
                                        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —â–æ –º–∏–Ω—É–ª–æ 3s –±–µ–∑ –Ω–æ–≤–∏—Ö —Ñ—ñ–Ω–∞–ª—å–Ω–∏—Ö
                                        if (Date.now() - this.lastFinalTimestamp >= this.SINGLE_INACTIVITY_MS - 50) {
                                            this.stopListening();
                                            this.sendMessage();
                                        }
                                    }, this.SINGLE_INACTIVITY_MS);
                                }
                            }
                        }
                    };

                    this.recognition.onerror = (event) => {
                        this.logMessage(`[VOICE] Error: ${event.error}`, 'error');
                        this.stopListening();
                    };

                    this.recognition.onend = () => {
                        // –Ø–∫—â–æ continuous —Ç–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∏–π TTS ‚Äì –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—î–º–æ
                        if (this.voiceMode === 'continuous' && this.isListening && !this.TTS_ACTIVE) {
                            try { this.recognition.start(); } catch(e) {}
                        } else {
                            if (!this.TTS_ACTIVE) {
                                this.isListening = false;
                                this.updateVoiceButton();
                            }
                        }
                    };
                }
            }

            bindEvents() {
                // Chat input events
                this.chatInput.addEventListener('keydown', (e) => {
                    // –§–Ü–ö–°–ê–¶–Ü–Ø: –î–æ–¥–∞—î–º–æ –≥–∞—Ä—è—á—É –∫–ª–∞–≤—ñ—à—É –¥–ª—è –ø—Ä–∏–º—É—Å–æ–≤–æ–≥–æ —Ä–æ–∑–±–ª–æ–∫—É–≤–∞–Ω–Ω—è –ø–æ–ª—è –≤–≤–æ–¥—É
                    if (e.ctrlKey && e.shiftKey && e.key === 'U') {
                        e.preventDefault();
                        this.isStreaming = false;
                        this.isStreamPending = false;
                        this._autoBlockedBySessions = false;
                        if (this.chatInput) {
                            this.chatInput.disabled = false;
                            this.logMessage('[INPUT] –ü—Ä–∏–º—É—Å–æ–≤–µ —Ä–æ–∑–±–ª–æ–∫—É–≤–∞–Ω–Ω—è –ø–æ–ª—è –≤–≤–æ–¥—É (Ctrl+Shift+U)', 'info');
                        }
                        return;
                    }
                    
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                this.chatInput.addEventListener('input', () => {
                    this.autoResizeTextarea();
                });

                // Voice button events
                this.voiceButton.addEventListener('click', () => {
                    this.handleVoiceButtonClick();
                });
            }

            handleVoiceButtonClick() {
                this.clickCount++;
                
                if (this.clickTimer) {
                    clearTimeout(this.clickTimer);
                }

                this.clickTimer = setTimeout(() => {
                    if (this.clickCount === 1) {
                        // Single click - continuous mode
                        this.toggleContinuousMode();
                    } else if (this.clickCount === 2) {
                        // Double click - single mode
                        this.startSingleMode();
                    }
                    this.clickCount = 0;
                }, 300);
            }

            toggleContinuousMode() {
                if (this.voiceMode === 'continuous') {
                    this.stopListening();
                    this.voiceMode = 'off';
                } else {
                    this.startContinuousMode();
                }
            }

            startContinuousMode() {
                if (!this.recognition) return;
                
                this.voiceMode = 'continuous';
                this.startListening();
                this.logMessage('[VOICE] Continuous mode activated', 'info');
            }

            startSingleMode() {
                if (!this.recognition) return;
                
                this.voiceMode = 'single';
                this.startListening();
                this.logMessage('[VOICE] Single command mode', 'info');
            }

            startListening() {
                if (!this.recognition || this.isListening) return;
                
                this.isListening = true;
                this.recognition.start();
                this.updateVoiceButton();
            }

            stopListening() {
                if (!this.recognition || !this.isListening) return;
                
                this.isListening = false;
                this.recognition.stop();
                if (this.voiceMode === 'single') {
                    this.voiceMode = 'off';
                }
                this.updateVoiceButton();
            }

            updateVoiceButton() {
                this.voiceButton.className = 'voice-button';
                
                if (this.voiceMode === 'continuous') {
                    this.voiceButton.classList.add('continuous');
                    this.voiceButton.textContent = 'üîÑüé§';
                } else if (this.isListening) {
                    this.voiceButton.classList.add('listening');
                    this.voiceButton.textContent = 'üî¥üé§';
                } else {
                    this.voiceButton.textContent = 'üé§';
                }
            }

            autoResizeTextarea() {
                this.chatInput.style.height = 'auto';
                this.chatInput.style.height = Math.min(this.chatInput.scrollHeight, 60) + 'px';
            }

            async sendMessage() {
                const message = this.chatInput.value.trim();
                
                // –§–Ü–ö–°–ê–¶–Ü–Ø: –î–æ–¥–∞—î–º–æ –¥–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è —Å—Ç–∞–Ω—É –ø–æ–ª—è –≤–≤–æ–¥—É
                this.logMessage(`[INPUT] –°–ø—Ä–æ–±–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è. –°—Ç–∞–Ω: isStreaming=${this.isStreaming}, isStreamPending=${this.isStreamPending}, disabled=${this.chatInput.disabled}`, 'info');
                
                // –ë–ª–æ–∫—É–≤–∞—Ç–∏ –Ω–∞–¥—Ç–æ –∫–æ—Ä–æ—Ç–∫—ñ –∞–±–æ –ø–æ—Ä–æ–∂–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
                if (!message || message.length < 2) {
                    this.logMessage('[CHAT] –í–≤–µ–¥—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (–º—ñ–Ω—ñ–º—É–º 2 —Å–∏–º–≤–æ–ª–∏)', 'warning');
                    return;
                }

                // –û—á–∏—Å—Ç–∏—Ç–∏ —Ç–∞–π–º–µ—Ä –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É, —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤—ñ–¥–ø—Ä–∞–≤–∏–≤ –≤—Ä—É—á–Ω—É
                if (this.singleModeSendTimer) {
                    clearTimeout(this.singleModeSendTimer);
                    this.singleModeSendTimer = null;
                }

                const userEl = this.addMessage(message, 'user');
                this.chatInput.value = '';
                this.autoResizeTextarea();

                // –Ø–∫—â–æ –≤–∂–µ –π–¥–µ —Å—Ç—Ä—ñ–º –∞–±–æ –æ—á—ñ–∫—É—î—Ç—å—Å—è –π–æ–≥–æ –ø–æ—á–∞—Ç–æ–∫
                if (this.isStreaming || this.isStreamPending) {
                    // –î–æ–¥–∞—î–º–æ —É —á–µ—Ä–≥—É
                    const timeDiv = userEl.querySelector('.message-time');
                    if (timeDiv) {
                        const badge = document.createElement('span');
                        badge.className = 'badge queued';
                        badge.textContent = '—É —á–µ—Ä–∑—ñ';
                        timeDiv.appendChild(badge);
                    }
                    this.messageQueue.push({ text: message, el: userEl });
                    this.logMessage(`[QUEUE] –î–æ–¥–∞–Ω–æ —É —á–µ—Ä–≥—É (len=${this.messageQueue.length})`);
                    return;
                }

                // –°–ø–æ—á–∞—Ç–∫—É –Ω–∞–º–∞–≥–∞—î–º–æ—Å—å —Å—Ç—Ä—ñ–º—ñ–Ω–≥–æ–º
                try {
                    await this.sendToAtlasStream(message);
                } catch (error) {
                    this.logMessage(`[CHAT] Stream error, fallback to non-stream: ${error.message}`, 'warning');
                    try {
                        const result = await this.sendToAtlas(message);
                        const el = this.addMessage(result?.text || String(result), 'assistant');
                        // –ü–æ—Å—Ç–∞–≤–∏—Ç–∏ –±–µ–π–¥–∂ –¥–∂–µ—Ä–µ–ª–∞ –Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å, –∞ –Ω–µ –Ω–∞ —é–∑–µ—Ä—Å—å–∫–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
                        try {
                            const badge = document.createElement('span');
                            badge.className = 'badge';
                            badge.textContent = result?.atlas_core ? 'Atlas' : 'API';
                            const td = el.querySelector('.message-time');
                            if (td) td.appendChild(badge);
                        } catch(_){}
                    } catch (e2) {
                        this.addMessage(`–ü–æ–º–∏–ª–∫–∞: ${e2.message}`, 'assistant');
                        this.logMessage(`[CHAT] Error: ${e2.message}`, 'error');
                    }
                }
            }

            async sendToAtlas(message) {
                const baseUrl = (window.ATLAS_API_BASE || 'http://localhost:8080').replace(/\/$/, '');
                const url = `${baseUrl}/api/chat`;
                
                // –í–∏–∑–Ω–∞—á–∞—î–º–æ —Ç–∏–ø —Å–µ—Å—ñ—ó –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
                let sessionType = null;
                if (this.sessionMode === 'new') {
                    sessionType = 'new_session';
                } else if (this.sessionMode === 'continue') {
                    sessionType = 'continue_session';
                }
                
                const requestData = { 
                    message,
                    session_type: sessionType
                };
                
                try {
                    // –°—Ç–≤–æ—Ä—é—î–º–æ AbortController –¥–ª—è —Ç–∞–π–º–∞—É—Ç—É (–ø—ñ–¥–≤–∏—â–µ–Ω–æ –¥–æ 180 —Å–µ–∫)
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 180000);
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId); // –°–∫–∞—Å–æ–≤—É—î–º–æ —Ç–∞–π–º–∞—É—Ç —è–∫—â–æ –∑–∞–ø–∏—Ç —É—Å–ø—ñ—à–Ω–∏–π
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –ø–æ—Ç–æ—á–Ω—É —Å–µ—Å—ñ—é
                        if (data.session_name) {
                            this.currentSessionName = data.session_name;
                        }
                        
                        // –í–∏—Ç—è–≥–∞—î–º–æ —Ç–µ–∫—Å—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–ª—è Atlas Core
                        const text = (data.atlas_response ?? data.response ?? data.message ?? '–í—ñ–¥–ø–æ–≤—ñ–¥—å –æ—Ç—Ä–∏–º–∞–Ω–∞');
                        return { text, atlas_core: !!data.atlas_core, raw: data };
                    } else {
                        this.logMessage(`[CHAT] HTTP ${response.status} (${url})`, 'warning');
                        return { text: '–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞', atlas_core: false };
                    }
                } catch (error) {
                    if (error.name === 'AbortError') {
                        this.logMessage(`[CHAT] –¢–∞–π–º–∞—É—Ç –∑–∞–ø–∏—Ç—É (${url})`, 'warning');
                        return { text: '–¢–∞–π–º–∞—É—Ç –∑–∞–ø–∏—Ç—É (180 —Å–µ–∫)', atlas_core: false };
                    }
                    this.logMessage(`[CHAT] Network error: ${error.message}`, 'error');
                    return { text: '–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è', atlas_core: false };
                }
            }

            // –ù–æ–≤–∏–π –º–µ—Ç–æ–¥: –ø–æ—Ç–æ–∫–æ–≤–∏–π —Å—Ç—Ä—ñ–º –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤—ñ–¥ –±–µ–∫–µ–Ω–¥—É
            async sendToAtlasStream(message, queuedEl = null, options = {}) {
                const baseUrl = (window.ATLAS_API_BASE || 'http://localhost:8080').replace(/\/$/, '');
                const isTaskLike = /–∑–∞–≤–¥–∞–Ω|–≤–∏–∫–æ–Ω–∞–π|–∑—Ä–æ–±–∏|task|build|run|execute|install|generate|—Å—Ç–≤–æ—Ä–∏/i.test(message);
                    const forceGoose = String(window.ATLAS_FORCE_GOOSE || '0') !== '0'; // –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ Atlas Core
                    const useRawGoose = forceGoose; // —É —Ä–µ–∂–∏–º—ñ Goose –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ 1:1 –ø—Ä–æ–∫—Å—ñ /api/chat/reply
                    // –¢–µ–ø–µ—Ä /api/chat/stream –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î Atlas Core –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
                    let endpoint = useRawGoose ? '/api/chat/reply' : '/api/chat/stream';
                let url = `${baseUrl}${endpoint}`;
                const concurrent = !!options.concurrent;

                // –í–∏–∑–Ω–∞—á–∞—î–º–æ —Ç–∏–ø —Å–µ—Å—ñ—ó –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
                let sessionType = null;
                if (this.sessionMode === 'new') sessionType = 'new_session';
                else if (this.sessionMode === 'continue') sessionType = 'continue_session';

                const requestData = { message, session_type: sessionType };

                // –°—Ç–≤–æ—Ä—é—î–º–æ placeholder –¥–ª—è –∞—Å–∏—Å—Ç–µ–Ω—Ç–∞, —è–∫–∏–π –±—É–¥–µ–º–æ –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏ —Ç–æ–∫–µ–Ω–∞–º–∏
                const container = this.chatMessages;
                const assistantEl = this.addMessage('', 'assistant');
                const textDiv = assistantEl.querySelector('.message-text');
                const timeDiv = assistantEl.querySelector('.message-time');
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5 * 60 * 1000); // 5 —Ö–≤ –º–∞–∫—Å–∏–º—É–º
                
                // –ü–æ–∑–Ω–∞—á–∞—î–º–æ, —â–æ –∑–∞–ø–∏—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ (—É –Ω–µ-–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–º—É —Ä–µ–∂–∏–º—ñ)
                if (!concurrent) this.isStreamPending = true;
                // –ú–∞–ª–µ–Ω—å–∫–∏–π –±–µ–π–¥–∂ –¥–∂–µ—Ä–µ–ª–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ (–¥–ª—è –ø—Ä–æ–∑–æ—Ä–æ—Å—Ç—ñ)
                try {
                    const src = document.createElement('span');
                    src.className = 'badge';
                    src.textContent = (endpoint === '/api/chat/reply') ? 'Goose' : 'Atlas';
                    timeDiv.appendChild(src);
                } catch(_){}

                // –Ø–∫—â–æ —Ü–µ –±—É–ª–æ —á–µ—Ä–≥–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è ‚Äî –∑–Ω—ñ–º–∞—î–º–æ –±–µ–π–¥–∂ "—É —á–µ—Ä–∑—ñ"
                if (queuedEl) {
                    try {
                        const b = queuedEl.querySelector('.badge.queued');
                        if (b) b.remove();
                    } catch(_){}
                }

                let accumulatedText = '';
                let doneReceived = false;
                let blockedFromFirstChunk = false; // –∫–æ–ª–∏ –ø—Ä–∏–π–¥–µ –ø–µ—Ä—à–∞ –ø–æ–¥—ñ—è, –∑–∞–±–ª–æ–∫—É—î–º–æ —ñ–Ω–ø—É—Ç
                const applyToken = (token) => {
                    if (!token) return;
                    textDiv.textContent += token;
                    accumulatedText += token;
                    container.scrollTop = container.scrollHeight;
                };

                try {
                    let res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData),
                        signal: controller.signal
                    });

                    if (!res.ok || !res.body) {
                        throw new Error(`HTTP ${res.status}`);
                    }

                    // –ß–∏—Ç–∞—î–º–æ text/event-stream –ø–æ—Å—Ç—Ä–æ—á–Ω–æ
                    const reader = res.body.getReader();
                    const decoder = new TextDecoder('utf-8');
                    let buffer = '';

                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        buffer += decoder.decode(value, { stream: true });

                        // –ü–æ–¥—ñ—ó —Ä–æ–∑–¥—ñ–ª—è—é—Ç—å—Å—è –ø–æ—Ä–æ–∂–Ω—ñ–º —Ä—è–¥–∫–æ–º. –û–±—Ä–æ–±–ª—è—î–º–æ –ª—ñ–Ω—ñ—ó –ø–æ –æ–¥–Ω—ñ–π
                        const lines = buffer.split('\n');
                        buffer = lines.pop();
                        for (const raw of lines) {
                            const line = raw.trim();
                            if (!line || line.startsWith(':')) continue; // –∫–æ–º–µ–Ω—Ç–∞—Ä keepalive –∞–±–æ –ø–æ—Ä–æ–∂–Ω—å–æ
                            if (line.startsWith('data:')) {
                                const jsonStr = line.slice(5).trim();
                                try {
                                    const obj = JSON.parse(jsonStr);
                                    // –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –¥–≤–æ—Ö —Ñ–æ—Ä–º–∞—Ç—ñ–≤:
                                    // 1) Goose: { type: 'token'|'done'|'status'|'error', ... }
                                    // 2) Atlas Core: { event: '...'; on final => atlas_response/response }
                                    if (obj.type) {
                                        // –ù–∞ –ø–µ—Ä—à—ñ–π –≤–∞–ª—ñ–¥–Ω—ñ–π –ø–æ–¥—ñ—ó –±–ª–æ–∫—É—î–º–æ —ñ–Ω–ø—É—Ç —ñ —Ñ—ñ–∫—Å—É—î–º–æ –∞–∫—Ç–∏–≤–Ω–∏–π —Å—Ç—Ä—ñ–º
                                        if (!blockedFromFirstChunk) {
                                            blockedFromFirstChunk = true;
                                            if (!concurrent) this.isStreamPending = false;
                                            if (!concurrent) this.isStreaming = true;
                                            if (!concurrent && this.chatInput) this.chatInput.disabled = true;
                                        }
                                        if (obj.type === 'token') {
                                            applyToken(obj.token || '');
                                        } else if (obj.type === 'done') {
                                            doneReceived = true;
                                        } else if (obj.type === 'status') {
                                            this.logMessage(`[SSE] ${obj.message || 'status'}`);
                                        } else if (obj.type === 'error') {
                                            throw new Error(obj.error || 'stream error');
                                        } else if (obj.type === 'Message' && obj.message) {
                                            try {
                                                const parts = obj.message.content || [];
                                                for (const c of parts) {
                                                    if (c && c.type === 'text' && typeof c.text === 'string') {
                                                        applyToken(c.text);
                                                    }
                                                }
                                            } catch(_) {}
                                        } else if (obj.type === 'Finish') {
                                            doneReceived = true;
                                        } else if (obj.type === 'Error') {
                                            throw new Error(obj.error || 'stream error');
                                        } else if (obj.type === 'ModelChange') {
                                            this.logMessage(`[Model] ${obj.model || ''} ${obj.mode ? '('+obj.mode+')' : ''}`);
                                        }
                                    } else if (obj.event) {
                                        if (!blockedFromFirstChunk) {
                                            blockedFromFirstChunk = true;
                                            if (!concurrent) this.isStreamPending = false;
                                            if (!concurrent) this.isStreaming = true;
                                            if (!concurrent && this.chatInput) this.chatInput.disabled = true;
                                        }
                                        // –ü—Ä–æ–º—ñ–∂–Ω—ñ –ø–æ–¥—ñ—ó –º–æ–∂–Ω–∞ –ª–æ–≥—É–≤–∞—Ç–∏
                                        if (obj.event === 'final') {
                                            const finalText = obj.atlas_response || obj.response || '';
                                            if (finalText) {
                                                // –î–ª—è Core —Å—Ç—Ä—ñ–º—É —Ç–æ–∫–µ–Ω—ñ–≤ –º–æ–∂–µ –Ω–µ –±—É—Ç–∏ ‚Äî –ø—Ä–æ—Å—Ç–æ –≤–∏–≤–æ–¥–∏–º–æ —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π —Ç–µ–∫—Å—Ç
                                                textDiv.textContent += finalText;
                                                accumulatedText += finalText;
                                            }
                                            doneReceived = true;
                                        } else {
                                            // –ª–µ–≥–∫–∏–π –ª–æ–≥
                                            const evtName = obj.event;
                                            this.logMessage(`[Core] ${evtName}`);
                                        }
                                    }
                                } catch (e) {
                                    // –Ø–∫—â–æ –ø—Ä–∏–π—à–æ–≤ plain text —Ç–æ–∫–µ–Ω
                                    if (!blockedFromFirstChunk) {
                                        blockedFromFirstChunk = true;
                                        if (!concurrent) this.isStreamPending = false;
                                        if (!concurrent) this.isStreaming = true;
                                        if (!concurrent && this.chatInput) this.chatInput.disabled = true;
                                    }
                                    applyToken(jsonStr);
                                }
                            }
                        }
                    }

                    if (!doneReceived) {
                        // –Ø–∫—â–æ –±–µ–∫–µ–Ω–¥ –Ω–µ –ø—Ä–∏—Å–ª–∞–≤ –ø–æ–¥—ñ—é done ‚Äî –ø—Ä–æ—Å—Ç–æ –∑–∞–≤–µ—Ä—à—É—î–º–æ
                        this.logMessage('[SSE] –ü–æ—Ç—ñ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
                    }

                    // –ü–æ—Å—Ç-–æ–±—Ä–æ–±–∫–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ (–ø–∞—Ä—Å–∏–Ω–≥ JSON —É —Ç—Ä—ñ–π–Ω–∏—Ö –ª–∞–ø–∫–∞—Ö)
                    try {
                        this.postProcessAssistantText(textDiv, accumulatedText);
                        this.maybeScheduleAutoReply(accumulatedText);
                    } catch (e) {
                        // —Ç–∏—Ö–æ
                    }

                } finally {
                    clearTimeout(timeoutId);
                    // –ö–†–ò–¢–ò–ß–ù–ê –§–Ü–ö–°–ê–¶–Ü–Ø: –ó–∞–≤–∂–¥–∏ —Ä–æ–∑–±–ª–æ–∫–æ–≤—É—î–º–æ —ñ–Ω–ø—É—Ç —Ç–∞ —Å–∫–∏–¥–∞—î–º–æ –ø—Ä–∞–ø–æ—Ä–µ—Ü—å —Å—Ç—Ä—ñ–º—É
                    if (!concurrent) {
                        this.isStreaming = false;
                        this.isStreamPending = false;
                        this._lastStreamFinishedAt = Date.now();
                        this._autoBlockGraceUntil = Date.now() + 10000; // 10—Å ¬´–≥—Ä–µ–π—Å¬ª –¥–ª—è —É–Ω–∏–∫–Ω–µ–Ω–Ω—è –º–∏—Ç—Ç—î–≤–æ–≥–æ –∞–≤—Ç–æ–±–ª–æ–∫—É
                        
                        // –°–∫–∏–¥–∞—î–º–æ –∞–≤—Ç–æ–±–ª–æ–∫—É–≤–∞–Ω–Ω—è –≤—ñ–¥ —Å–µ—Å—ñ–π
                        this._autoBlockedBySessions = false;
                        
                        // –ì–ê–†–ê–ù–¢–û–í–ê–ù–ê –§–Ü–ö–°–ê–¶–Ü–Ø: –†–æ–∑–±–ª–æ–∫–æ–≤—É—î–º–æ —ñ–Ω–ø—É—Ç –∑ –∑–∞—Ç—Ä–∏–º–∫–æ—é –¥–ª—è –Ω–∞–¥—ñ–π–Ω–æ—Å—Ç—ñ
                        setTimeout(() => {
                            if (this.chatInput && !this.isStreaming && !this.isStreamPending) {
                                this.chatInput.disabled = false;
                                this.logMessage('[INPUT] –ü–æ–ª–µ –≤–≤–æ–¥—É —Ä–æ–∑–±–ª–æ–∫–æ–≤–∞–Ω–æ –ø—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Å—Ç—Ä—ñ–º—É', 'success');
                            }
                        }, 100);
                        
                        // –î–æ–¥–∞—Ç–∫–æ–≤–∏–π –±–µ–∫–∞–ø —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                        setTimeout(() => {
                            if (this.chatInput && !this.isStreaming && !this.isStreamPending && this.chatInput.disabled) {
                                this.chatInput.disabled = false;
                                this.logMessage('[INPUT] BACKUP —Ä–æ–∑–±–ª–æ–∫—É–≤–∞–Ω–Ω—è –ø–æ–ª—è –≤–≤–æ–¥—É', 'warning');
                            }
                        }, 1000);
                    }

                    // –Ø–∫—â–æ —î —á–µ—Ä–≥–∞ ‚Äî –∑–∞–ø—É—Å–∫–∞—î–º–æ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –µ–ª–µ–º–µ–Ω—Ç (—Ç—ñ–ª—å–∫–∏ —É –Ω–µ-–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–º—É —Ä–µ–∂–∏–º—ñ)
                    if (!concurrent && this.messageQueue.length > 0) {
                        const next = this.messageQueue.shift();
                        if (typeof next === 'string') {
                            try { await this.sendToAtlasStream(next); } catch(_){}
                        } else if (next && next.text) {
                            try { await this.sendToAtlasStream(next.text, next.el || null); } catch(_){}
                        }
                    }
                }
            }

            // –í–∏—Ç—è–≥ —ñ —Ä–µ–Ω–¥–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–æ–≥–æ JSON —ñ–∑ —Ç–µ–∫—Å—Ç—É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
            postProcessAssistantText(textDiv, rawText) {
                if (!rawText) return;
                const extractJson = (s) => {
                    // ```json ... ```
                    const fence = s.match(/```json\s*([\s\S]*?)```/i);
                    if (fence && fence[1]) return fence[1];
                    // –≥–æ–ª–∏–π JSON
                    const plain = s.trim();
                    if (plain.startsWith('{') && plain.endsWith('}')) return plain;
                    return null;
                };
                const jsonStr = extractJson(rawText);
                if (!jsonStr) return;
                try {
                    const obj = JSON.parse(jsonStr);
                    const completed = obj.completed;
                    const details = obj.details || obj.message || obj.reason || '';
                    const summary = (completed === false)
                        ? `–°—Ç–∞—Ç—É—Å: –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–æ. –î–µ—Ç–∞–ª—ñ: ${details}`
                        : (completed === true)
                            ? `–°—Ç–∞—Ç—É—Å: –∑–∞–≤–µ—Ä—à–µ–Ω–æ. ${details ? '–î–µ—Ç–∞–ª—ñ: ' + details : ''}`
                            : details || rawText;
                    textDiv.textContent = summary;
                } catch (_) {
                    // —è–∫—â–æ JSON –±–∏—Ç–∏–π ‚Äî –ª–∏—à–∞—î–º–æ —è–∫ —î
                }
            }

            // –Ø–∫—â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤–∏–º–∞–≥–∞—î –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è, –ø–ª–∞–Ω—É—î–º–æ –∞–≤—Ç–æ–¥–æ–≤–µ–¥–µ–Ω–Ω—è —á–µ—Ä–µ–∑ 10—Å
            maybeScheduleAutoReply(fullText) {
                try { if (this.autoReplyTimer) { clearTimeout(this.autoReplyTimer); this.autoReplyTimer = null; } } catch(_){}
                this.autoReplyActive = false;
                if (!fullText) return;

                const lower = fullText.toLowerCase();
                const looksLikeQuestion = /–ø–µ—Ä–µ–≤—ñ—Ä|—á–∏\s+–ø–æ—Ç—Ä—ñ–±–Ω–æ|—Ö–æ—á–µ—Ç–µ|–ø—ñ–¥—Ç–≤–µ—Ä–¥|–ø–µ—Ä–µ–≤i—Ä/.test(lower);
                let jsonFlag = false;
                try {
                    const fence = fullText.match(/```json\s*([\s\S]*?)```/i);
                    if (fence && fence[1]) {
                        const o = JSON.parse(fence[1]);
                        jsonFlag = (o && o.completed === false);
                    }
                } catch(_){}

                if (!(looksLikeQuestion || jsonFlag)) return;

                this.autoReplyActive = true;
                this.logMessage('[AUTO] –û—á—ñ–∫—É–≤–∞–Ω–Ω—è 10—Å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞‚Ä¶ –ø–æ—Ç—ñ–º –∞–≤—Ç–æ–ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è', 'warning');

                const cancel = () => {
                    if (this.autoReplyTimer) {
                        clearTimeout(this.autoReplyTimer);
                        this.autoReplyTimer = null;
                        if (this.autoReplyActive) this.logMessage('[AUTO] –°–∫–∞—Å–æ–≤–∞–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º', 'info');
                        this.autoReplyActive = false;
                    }
                };
                // –°–∫–∞—Å—É–≤–∞–Ω–Ω—è –ø—Ä–∏ –±—É–¥—å-—è–∫–æ–º—É –≤–≤–æ–¥—ñ
                const inputHandler = () => cancel();
                this.chatInput.addEventListener('input', inputHandler, { once: true });

                this.autoReplyTimer = setTimeout(() => {
                    this.autoReplyTimer = null;
                    if (!this.autoReplyActive) return;
                    this.autoReplyActive = false;
                    const followup = '–¢–∞–∫, –ø—Ä–æ–¥–æ–≤–∂—É–π –±–µ–∑ –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω—å —ñ –¥–æ–≤–µ–¥–∏ –∑–∞–≤–¥–∞–Ω–Ω—è –¥–æ –∫—ñ–Ω—Ü—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.';
                    this.chatInput.value = followup;
                    this.autoResizeTextarea();
                    this.sendMessage();
                    this.logMessage('[AUTO] –ù–∞–¥—ñ—Å–ª–∞–Ω–æ –∞–≤—Ç–æ–ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è', 'info');
                }, 10000);
            }

            addMessage(text, type) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                
                const textDiv = document.createElement('div');
                textDiv.className = 'message-text';
                textDiv.textContent = text;
                
                const timeDiv = document.createElement('div');
                timeDiv.className = 'message-time';
                timeDiv.textContent = new Date().toLocaleTimeString();
                
                messageDiv.appendChild(textDiv);
                messageDiv.appendChild(timeDiv);
                
                this.chatMessages.appendChild(messageDiv);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;

                // –Ø–∫—â–æ –ø—Ä–∏–π—à–ª–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∞—Å–∏—Å—Ç–µ–Ω—Ç–∞ —ñ –º–∏ —É continuous —Ä–µ–∂–∏–º—ñ ‚Äì –ø–∞—É–∑–∞ —â–æ–± –Ω–µ —Å–ª—É—Ö–∞—Ç–∏ TTS (–µ–≤—Ä–∏—Å—Ç–∏–∫–∞)
                if (type === 'assistant' && this.voiceMode === 'continuous') {
                    this.simulateTTSPause(text);
                }

                return messageDiv;
            }

            logMessage(text, type = 'info', customColor = null) {
                const logDiv = document.createElement('div');
                logDiv.className = 'log-line';
                
                // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –∫–∞—Å—Ç–æ–º–Ω–∏–π –∫–æ–ª—ñ—Ä –∞–±–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π
                if (customColor) {
                    logDiv.style.color = customColor;
                } else if (type === 'error') {
                    logDiv.classList.add('error');
                } else if (type === 'warning') {
                    logDiv.classList.add('warning');
                }
                
                logDiv.textContent = text;
                
                this.logsContainer.appendChild(logDiv);
                this.logsContainer.scrollTop = this.logsContainer.scrollHeight;
                
                // –ó–±–µ—Ä—ñ–≥–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –æ—Å—Ç–∞–Ω–Ω—ñ 300 —Ä—è–¥–∫—ñ–≤ –ª–æ–≥—ñ–≤
                while (this.logsContainer.children.length > 300) {
                    this.logsContainer.removeChild(this.logsContainer.firstChild);
                }
            }

            startMCPLogging() {
                // –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —á–µ—Ä–µ–∑ Server-Sent Events –¥–æ /logs/stream –Ω–∞ frontend —Å–µ—Ä–≤–µ—Ä—ñ
                const baseUrl = (window.ATLAS_API_BASE || 'http://localhost:8080').replace(/\/$/, '');
                const streamUrl = `${baseUrl}/logs/stream`;
                this.logMessage(`[INIT] –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –ø–æ—Ç–æ–∫—É –ª–æ–≥—ñ–≤: ${streamUrl}`);
                let retryDelay = 2000;
                const maxDelay = 15000;

                const connect = () => {
                    try {
                        const es = new EventSource(streamUrl);
                        this._eventSource = es;
                        es.onopen = () => {
                            this.logMessage(`[SSE] –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ (retryDelay=${retryDelay}ms)`);
                            retryDelay = 2000; // reset
                        };
                        es.onmessage = (evt) => {
                            if (!evt.data) return;
                            try {
                                const entry = JSON.parse(evt.data);
                                const ts = entry.timestamp || new Date().toISOString();
                                const lvl = (entry.level || 'INFO').toUpperCase();
                                const src = entry.source || 'atlas';
                                const msg = entry.message || '';
                                this.logMessage(`[${ts}] [${lvl}] ${src}: ${msg}`);
                            } catch (e) {
                                // raw line fallback
                                this.logMessage(`[SSE_RAW] ${evt.data}`);
                            }
                        };
                        es.onerror = () => {
                            es.close();
                            this.logMessage(`[SSE] –†–æ–∑'—î–¥–Ω–∞–Ω–æ, –ø–æ–≤—Ç–æ—Ä–Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —á–µ—Ä–µ–∑ ${(retryDelay/1000).toFixed(1)}s`, 'warning');
                            setTimeout(connect, retryDelay);
                            retryDelay = Math.min(maxDelay, retryDelay * 1.7);
                        };
                    } catch (err) {
                        this.logMessage(`[SSE] –ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó: ${err.message}`, 'error');
                        setTimeout(connect, retryDelay);
                        retryDelay = Math.min(maxDelay, retryDelay * 1.7);
                    }
                };
                connect();
                // Fallback –ø–æ—á–∞—Ç–∫–æ–≤–µ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –æ—Å—Ç–∞–Ω–Ω—ñ—Ö –ª–æ–≥—ñ–≤ —è–∫—â–æ SSE –ø–æ–≤—ñ–ª—å–Ω–æ —Å—Ç–∞—Ä—Ç—É—î
                this.pollLiveLogs(true);
            }

            async pollLiveLogs(initial = false) {
                // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ª–æ–≥—ñ–≤ Goose
                if (!initial) return;
                const baseUrl = (window.ATLAS_API_BASE || 'http://localhost:8080').replace(/\/$/, '');
                const url = `${baseUrl}/logs?limit=100`;
                try {
                    const response = await fetch(url);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.logs && data.logs.length > 0) {
                            this.logsContainer.innerHTML = '';
                            data.logs.forEach(log => {
                                // –§–æ—Ä–º–∞—Ç—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –∫–æ–ª—å–æ—Ä–∞–º–∏ —Ç–∞ —ñ–∫–æ–Ω–∫–∞–º–∏
                                let level = log.level.toLowerCase();
                                let icon = 'üìÑ';
                                let color = '#4a9c5a';
                                
                                if (log.source === 'goose_session') {
                                    icon = 'ü§ñ';
                                    color = '#00ff41';
                                } else if (log.source === 'goose_task') {
                                    icon = 'üìã';
                                    color = '#61dafb';
                                } else if (log.source === 'atlas_monitor') {
                                    icon = 'üîç';
                                    color = '#98fb98';
                                } else if (level === 'error') {
                                    icon = '‚ùå';
                                    color = '#d16969';
                                } else if (level === 'warning') {
                                    icon = '‚ö†Ô∏è';
                                    color = '#d19a66';
                                }
                                
                                const message = `[${log.timestamp}] ${icon} ${log.message}`;
                                this.logMessage(message, level, color);
                            });
                        }
                    }
                } catch(e) { 
                    this.logMessage(`[${new Date().toLocaleTimeString()}] ‚ùå Error fetching logs: ${e.message}`, 'error');
                }
                
                // –ó–∞–ø—É—Å–∫–∞—î–º–æ –ø–µ—Ä—ñ–æ–¥–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–∂–Ω—ñ 2 —Å–µ–∫—É–Ω–¥–∏
                if (initial) {
                    setInterval(() => this.refreshLogs(), 2000);
                }
            }
            
            async refreshLogs() {
                // –ú–µ—Ç–æ–¥ –¥–ª—è –ø–µ—Ä—ñ–æ–¥–∏—á–Ω–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ª–æ–≥—ñ–≤
                const baseUrl = (window.ATLAS_API_BASE || 'http://localhost:8080').replace(/\/$/, '');
                const url = `${baseUrl}/logs?limit=50`;
                try {
                    const response = await fetch(url);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.logs && data.logs.length > 0) {
                            // –î–æ–¥–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ –Ω–æ–≤—ñ –ª–æ–≥–∏ (–æ—Å—Ç–∞–Ω–Ω—ñ 5)
                            const recentLogs = data.logs.slice(-5);
                            recentLogs.forEach(log => {
                                let level = log.level.toLowerCase();
                                let icon = 'üìÑ';
                                let color = '#4a9c5a';
                                
                                if (log.source === 'goose_session') {
                                    icon = 'ü§ñ';
                                    color = '#00ff41';
                                } else if (log.source === 'goose_task') {
                                    icon = 'üìã';
                                    color = '#61dafb';
                                } else if (log.source === 'atlas_monitor') {
                                    icon = 'üîç';
                                    color = '#98fb98';
                                } else if (level === 'error') {
                                    icon = '‚ùå';
                                    color = '#d16969';
                                } else if (level === 'warning') {
                                    icon = '‚ö†Ô∏è';
                                    color = '#d19a66';
                                }
                                
                                const message = `[${log.timestamp}] ${icon} ${log.message}`;
                                this.logMessage(message, level, color);
                            });
                        }
                    }
                } catch(e) { 
                    // –Ü–≥–Ω–æ—Ä—É—î–º–æ –ø–æ–º–∏–ª–∫–∏ –ø—Ä–∏ –ø–µ—Ä—ñ–æ–¥–∏—á–Ω–æ–º—É –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ
                }
            }

            simulateTTSPause(text) {
                // –ï–≤—Ä–∏—Å—Ç–∏—á–Ω–∏–π —á–∞—Å –º–æ–≤–ª–µ–Ω–Ω—è: ~120 —Å–ª—ñ–≤/—Ö–≤ ‚âà 2 —Å–ª–æ–≤–∞/—Å–µ–∫; —Å–ª–æ–≤–æ ~5 —Å–∏–º–≤–æ–ª—ñ–≤
                const charCount = text.length;
                const approxSeconds = Math.min(10, Math.max(2, charCount / 11));
                this.TTS_ACTIVE = true;
                // –ü–∞—É–∑–∞ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è
                if (this.isListening) {
                    try { this.recognition.stop(); } catch(e) {}
                }
                // –ü–ª–∞–Ω—É—î–º–æ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è
                if (this.TTSBlockTimer) clearTimeout(this.TTSBlockTimer);
                this.TTSBlockTimer = setTimeout(() => {
                    this.TTS_ACTIVE = false;
                    if (this.voiceMode === 'continuous') {
                        this.isListening = true;
                        try { this.recognition.start(); } catch(e) {}
                        this.updateVoiceButton();
                    }
                }, approxSeconds * 1000);
            }

            startStatusMonitoring() {
                // –ó–∞–ø—É—Å–∫ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É —Å—Ç–∞—Ç—É—Å—É —Å–∏—Å—Ç–µ–º–∏
                this.updateSystemStatus();
                // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–∂–Ω—ñ 5 —Å–µ–∫—É–Ω–¥
                setInterval(() => {
                    this.updateSystemStatus();
                }, 5000);
            }

            async updateSystemStatus() {
                try {
                    // –û—Ç—Ä–∏–º—É—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º–∏
                    const response = await fetch('/api/status');
                    let status = {};
                    
                    if (response.ok) {
                        status = await response.json();
                    } else {
                        status = {
                            error: "Status unavailable",
                            timestamp: new Date().toISOString()
                        };
                    }
                    
                    // –î–æ–¥–∞—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ Goose —Å–µ—Å—ñ—ó (–ª–∏—à–µ –¥–ª—è —Å—Ç–∞—Ç—É—Å—É, –±–µ–∑ –∞–≤—Ç–æ-–±–ª–æ–∫—ñ–≤ —ñ–Ω–ø—É—Ç—É)
                    try {
                        const gooseResponse = await fetch('/api/goose/sessions');
                        if (gooseResponse.ok) {
                            const gooseData = await gooseResponse.json();
                            status.goose_sessions = {
                                count: gooseData.count || 0,
                                latest: gooseData.sessions && gooseData.sessions.length > 0 ? 
                                    gooseData.sessions[0].name : 'None',
                                status: gooseData.count > 0 ? 'active' : 'inactive'
                            };

                            // –í–∏—Ä—ñ–≤–Ω—é—î–º–æ –ø–æ–≤–µ–¥—ñ–Ω–∫—É –∑ –≤–µ–±-—á–∞—Ç–æ–º (–ø–æ—Ä—Ç 3000):
                            // —ñ–Ω–ø—É—Ç –±–ª–æ–∫—É—î–º–æ —Ç—ñ–ª—å–∫–∏ –ø—ñ–¥ —á–∞—Å –í–õ–ê–°–ù–û–ì–û —Å—Ç—Ä—ñ–º—É (isStreaming/isStreamPending).
                            // –Ø–∫—â–æ —Ä–∞–Ω—ñ—à–µ –±—É–≤ –∞–≤—Ç–æ–±–ª–æ–∫ ‚Äî –∑–Ω—ñ–º–∞—î–º–æ –π–æ–≥–æ.
                            if (this._autoBlockedBySessions && !this.isStreaming && !this.isStreamPending) {
                                if (this.chatInput) this.chatInput.disabled = false;
                                this._autoBlockedBySessions = false;
                            }
                        }
                    } catch (e) {
                        status.goose_sessions = {
                            count: 0,
                            latest: 'Error',
                            status: 'error'
                        };
                    }
                    
                    this.renderSystemStatus(status);
                } catch (error) {
                    this.renderSystemStatus({
                        error: error.message,
                        timestamp: new Date().toISOString()
                    });
                }
            }

            renderSystemStatus(status) {
                try {
                    // –ü—Ä–æ—Ü–µ—Å–∏
                    if (status.processes) {
                        const processHTML = Object.entries(status.processes).map(([type, info]) => {
                            const count = info.count || 0;
                            const statusClass = count > 0 ? 'online' : 'warning';
                            return `<div class="status-item ${statusClass}">${type}: ${count}</div>`;
                        }).join('');
                        this.processStatus.innerHTML = processHTML;
                    }

                    // –°–µ—Ä–≤—ñ—Å–∏
                    if (status.services) {
                        const serviceHTML = Object.entries(status.services).map(([name, info]) => {
                            const serviceStatus = info.status || 'unknown';
                            let statusClass = 'warning';
                            if (serviceStatus === 'online' || serviceStatus === 'operational' || serviceStatus === 'running') {
                                statusClass = 'online';
                            } else if (serviceStatus === 'offline' || serviceStatus === 'error') {
                                statusClass = 'error';
                            }
                            return `<div class="status-item ${statusClass}">${name}: ${serviceStatus}</div>`;
                        }).join('');
                        this.serviceStatus.innerHTML = serviceHTML;
                    }

                    // –ú–µ—Ä–µ–∂–∞
                    if (status.network && status.network.connections) {
                        const connCount = status.network.connections.count || 0;
                        const statusClass = connCount > 0 ? 'online' : 'warning';
                        this.networkStatus.innerHTML = `<div class="status-item ${statusClass}">Connections: ${connCount}</div>`;
                    }

                    // –†–µ—Å—É—Ä—Å–∏ –∑ –¥–æ–¥–∞–≤–∞–Ω–Ω—è–º Goose —Å–µ—Å—ñ–π
                    if (status.resources || status.goose_sessions) {
                        let resourceHTML = '';
                        
                        // CPU —Ç–∞ Disk (—è–∫ —Ä–∞–Ω—ñ—à–µ)
                        if (status.resources) {
                            if (status.resources.cpu && status.resources.cpu.usage_line) {
                                const cpuInfo = status.resources.cpu.usage_line;
                                resourceHTML += `<div class="status-item online">CPU: ${cpuInfo.substring(0, 30)}...</div>`;
                            } else {
                                resourceHTML += `<div class="status-item warning">CPU: --</div>`;
                            }
                            
                            if (status.resources.disk && status.resources.disk.usage_percent) {
                                const diskUsage = status.resources.disk.usage_percent;
                                const usageNum = parseInt(diskUsage);
                                const statusClass = usageNum > 90 ? 'error' : usageNum > 70 ? 'warning' : 'online';
                                resourceHTML += `<div class="status-item ${statusClass}">Disk: ${diskUsage}</div>`;
                            } else {
                                resourceHTML += `<div class="status-item warning">Disk: --</div>`;
                            }
                        }
                        
                        // –î–æ–¥–∞—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ Goose —Å–µ—Å—ñ—ó
                        if (status.goose_sessions) {
                            const count = status.goose_sessions.count || 0;
                            const latest = status.goose_sessions.latest || 'None';
                            const sessionStatus = status.goose_sessions.status || 'unknown';
                            
                            let statusClass = 'warning';
                            if (sessionStatus === 'active' && count > 0) {
                                statusClass = 'online';
                            } else if (sessionStatus === 'error') {
                                statusClass = 'error';
                            }
                            
                            resourceHTML += `<div class="status-item ${statusClass}">ü§ñ Goose: ${count} sessions</div>`;
                            if (latest !== 'None' && latest !== 'Error') {
                                const shortName = latest.length > 25 ? latest.substring(0, 25) + '...' : latest;
                                resourceHTML += `<div class="status-item online">üìã Latest: ${shortName}</div>`;
                            }
                        }
                        
                        this.resourceStatus.innerHTML = resourceHTML;
                    }

                } catch (error) {
                    console.error('Status rendering error:', error);
                }
            }
        }

        // –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–ï–†–ï–ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–¨
        window.atlasPageLoadId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        console.log('üîÑ ATLAS RELOAD DETECTION:', window.atlasPageLoadId, 'at', new Date().toTimeString());
        
        // –ó–ê–ü–û–ë–Ü–ì–ê–ù–ù–Ø –¶–ò–ö–õ–Ü–ß–ù–ò–ú –ü–ï–†–ï–ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø–ú
        const lastReloadTime = sessionStorage.getItem('atlasLastReload');
        const currentTime = Date.now();
        
        if (lastReloadTime && (currentTime - parseInt(lastReloadTime)) < 5000) {
            console.warn('üõë SUSPECTED RELOAD LOOP - Adding protection');
            // –î–æ–¥–∞—î–º–æ –∑–∞—Ç—Ä–∏–º–∫—É, —â–æ–± –ø–µ—Ä–µ—Ä–≤–∞—Ç–∏ –º–æ–∂–ª–∏–≤–∏–π —Ü–∏–∫–ª –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—å
            setTimeout(() => {
                console.log('üîì Reload protection timeout finished');
            }, 2000);
        }
        
        sessionStorage.setItem('atlasLastReload', currentTime.toString());
        
        // Initialize the interface when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –µ–∫–∑–µ–º–ø–ª—è—Ä –≥–ª–æ–±–∞–ª—å–Ω–æ, —â–æ–± —ñ–Ω—à—ñ —Å–∫—Ä–∏–ø—Ç–∏ –º–æ–≥–ª–∏ –∑–≤–µ—Ä—Ç–∞—Ç–∏—Å—è
            window.atlasInterface = new AtlasMinimalInterface();
            
            // –ü–æ—á–∞—Ç–∫–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–µ—Å—ñ–π Goose –¥–ª—è –º–∏—Ç—Ç—î–≤–æ–≥–æ –∞–≤—Ç–æ-–±–ª–æ–∫—É–≤–∞–Ω–Ω—è
            try {
                window.atlasInterface.updateSystemStatus();
                // –ì–∞—Ä–∞–Ω—Ç—É—î–º–æ —Ä–æ–∑–±–ª–æ–∫—É–≤–∞–Ω–Ω—è —ñ–Ω–ø—É—Ç—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ, —è–∫—â–æ –Ω–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å—Ç—Ä—ñ–º—É
                if (!window.atlasInterface.isStreaming && !window.atlasInterface.isStreamPending) {
                    const input = document.getElementById('chatInput');
                    if (input) {
                        input.disabled = false;
                        window.atlasInterface.logMessage('[INPUT] –ü–æ–ª–µ –≤–≤–æ–¥—É –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ —Ä–æ–∑–±–ª–æ–∫–æ–≤–∞–Ω–æ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ', 'info');
                    }
                }
            } catch(_) {}
            
            // –î–û–î–ê–¢–ö–û–í–û: –ó–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –≤–∏–ø–∞–¥–∫–æ–≤–æ–≥–æ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏
            let refreshWarningShown = false;
            window.addEventListener('beforeunload', (e) => {
                console.log('‚ö†Ô∏è ATLAS BEFOREUNLOAD TRIGGERED:', window.atlasPageLoadId, 'at', new Date().toTimeString());
                
                const iface = window.atlasInterface;
                const isStreaming = iface && (iface.isStreaming || iface.isStreamPending);
                
                // –ó–∞—Ö–∏—â–∞—î–º–æ –≤—ñ–¥ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—å –ø—Ä–æ—Ç—è–≥–æ–º –ø–µ—Ä—à–∏—Ö 10 —Å–µ–∫—É–Ω–¥ –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
                const pageAge = Date.now() - parseInt(window.atlasPageLoadId.split('_')[0]);
                const isRecentLoad = pageAge < 10000;
                
                if ((isStreaming || isRecentLoad) && !refreshWarningShown) {
                    console.log(`‚ùå PREVENTING RELOAD: streaming=${isStreaming}, recentLoad=${isRecentLoad}, pageAge=${pageAge}ms`);
                    e.preventDefault();
                    
                    let message = '–ó–∞—á–µ–∫–∞–π—Ç–µ...';
                    if (isStreaming) message = '–°—Ç—Ä—ñ–º —â–µ —Ç—Ä–∏–≤–∞—î. –í–∏ –¥—ñ–π—Å–Ω–æ —Ö–æ—á–µ—Ç–µ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É?';
                    else if (isRecentLoad) message = '–°—Ç–æ—Ä—ñ–Ω–∫–∞ —â–æ–π–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–∞—Å—è. –ó–∞—á–µ–∫–∞–π—Ç–µ –∫—ñ–ª—å–∫–∞ —Å–µ–∫—É–Ω–¥.';
                    
                    e.returnValue = message;
                    refreshWarningShown = true;
                    setTimeout(() => { refreshWarningShown = false; }, 3000);
                    return e.returnValue;
                } else {
                    console.log('‚úÖ RELOAD ALLOWED (no active stream, page age: ' + pageAge + 'ms)');
                }
            });

            // –§–Ü–ö–°–ê–¶–Ü–Ø: –î–æ–¥–∞—î–º–æ —ñ–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –ø–µ—Ä—ñ–æ–¥–∏—á–Ω–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å—Ç–∞–Ω—É –ø–æ–ª—è –≤–≤–æ–¥—É
            setInterval(() => {
                try {
                    const input = document.getElementById('chatInput');
                    const iface = window.atlasInterface;
                    
                    // –ë—ñ–ª—å—à –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–∞ –ª–æ–≥—ñ–∫–∞ —Ñ—ñ–∫—Å–∞—Ü—ñ—ó
                    if (input && iface && input.disabled) {
                        const timeSinceLastStream = Date.now() - (iface._lastStreamFinishedAt || 0);
                        
                        // –†–æ–∑–±–ª–æ–∫–æ–≤—É—î–º–æ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ:
                        // 1) –ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å—Ç—Ä—ñ–º—É
                        // 2) –ü—Ä–æ–π—à–ª–æ –¥–æ—Å—Ç–∞—Ç–Ω—å–æ —á–∞—Å—É –∑ –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ —Å—Ç—Ä—ñ–º—É (5+ —Å–µ–∫—É–Ω–¥)
                        // 3) –ù–µ–º–∞—î pending —Å—Ç—Ä—ñ–º—É
                        if (!iface.isStreaming && !iface.isStreamPending && timeSinceLastStream > 5000) {
                            input.disabled = false;
                            iface.logMessage('[INPUT] –ê–≤—Ç–æ—Ñ—ñ–∫—Å–∞—Ü—ñ—è: –ø–æ–ª–µ –≤–≤–æ–¥—É —Ä–æ–∑–±–ª–æ–∫–æ–≤–∞–Ω–æ', 'warning');
                        }
                    }
                } catch(e) {
                    // –¢–∏—Ö–æ —ñ–≥–Ω–æ—Ä—É—î–º–æ –ø–æ–º–∏–ª–∫–∏, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ —Å–ø–∞–º—É –≤ –∫–æ–Ω—Å–æ–ª—ñ
                }
            }, 3000); // –ö–æ–∂–Ω—ñ 3 —Å–µ–∫—É–Ω–¥–∏ (–º–µ–Ω—à–µ –∞–≥—Ä–µ—Å–∏–≤–Ω–æ)
        });
    </script>

    <!-- –£–±—Ä–∞–ª–∏ –¥—É–±–ª—é—é—â–∏–π –Ω–µ—Å—Ç—Ä–∏–º–∏–Ω–≥–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç; –≤—Å—è –ª–æ–≥–∏–∫–∞ —á–∞—Ç—É –≤ AtlasMinimalInterface -->
</body>
</html>
