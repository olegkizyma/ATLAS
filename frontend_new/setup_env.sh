#!/bin/bash
# ATLAS Environment Setup Script
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Python —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞

set -e  # –ó—É–ø–∏–Ω—è—Ç–∏—Å—è –ø—Ä–∏ –ø–æ–º–∏–ª–∫–∞—Ö

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VENV_DIR="$SCRIPT_DIR/venv"
REQUIREMENTS_FILE="$SCRIPT_DIR/requirements.txt"

echo "üîß ATLAS Environment Setup"
echo "=========================="

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —ñ—Å–Ω—É—î Python 3
if ! command -v python3 &> /dev/null; then
    echo "‚ùå Python 3 –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –ë—É–¥—å –ª–∞—Å–∫–∞ –≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å Python 3."
    exit 1
fi

echo "‚úÖ Python 3 –∑–Ω–∞–π–¥–µ–Ω–æ: $(python3 --version)"

# –°—Ç–≤–æ—Ä—é—î–º–æ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ —è–∫—â–æ –Ω–µ —ñ—Å–Ω—É—î
if [ ! -d "$VENV_DIR" ]; then
    echo "üì¶ –°—Ç–≤–æ—Ä—é—î–º–æ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ..."
    python3 -m venv "$VENV_DIR"
    echo "‚úÖ –í—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ —Å—Ç–≤–æ—Ä–µ–Ω–æ: $VENV_DIR"
else
    echo "‚úÖ –í—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ –≤–∂–µ —ñ—Å–Ω—É—î: $VENV_DIR"
fi

# –ê–∫—Ç–∏–≤—É—î–º–æ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ
echo "üîÑ –ê–∫—Ç–∏–≤—É—î–º–æ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ..."
source "$VENV_DIR/bin/activate"

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —â–æ –º–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É —Å–µ—Ä–µ–¥–æ–≤–∏—â—ñ
if [[ "$VIRTUAL_ENV" == "$VENV_DIR" ]]; then
    echo "‚úÖ –í—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ: $VIRTUAL_ENV"
else
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞"
    exit 1
fi

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Ç—Ä–µ–±–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª—é–≤–∞—Ç–∏ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
if python -c "import flask" 2>/dev/null; then
    echo "‚úÖ –ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤–∂–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
else
    # –û–Ω–æ–≤–ª—é—î–º–æ pip
    echo "‚¨ÜÔ∏è  –û–Ω–æ–≤–ª—é—î–º–æ pip..."
    pip install --upgrade pip

    # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
    if [ -f "$REQUIREMENTS_FILE" ]; then
        echo "üì¶ –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –∑ requirements.txt..."
        pip install -r "$REQUIREMENTS_FILE"
        echo "‚úÖ –í—Å—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
    else
        echo "‚ö†Ô∏è  –§–∞–π–ª requirements.txt –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ: $REQUIREMENTS_FILE"
    fi
fi

# –ü–æ–∫–∞–∑—É—î–º–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ –ø–∞–∫–µ—Ç–∏
echo ""
echo "üìã –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ –ø–∞–∫–µ—Ç–∏:"
pip list --format=columns 2>/dev/null || pip list

echo ""
echo "üéâ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "–î–ª—è –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ –≤ –º–∞–π–±—É—Ç–Ω—å–æ–º—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ:"
echo "source $VENV_DIR/bin/activate"
echo ""
echo "–î–ª—è –¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—ó:"
echo "deactivate"
