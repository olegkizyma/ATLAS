#!/bin/bash

# ATLAS System Build Script
# ะกะบัะธะฟั ะบะพะผะฟัะปัััั ัะธััะตะผะธ ATLAS
# ะะบะปััะฐั: Goose AI Agent ัะฑะพัะบะฐ

echo "๐จ ะะพะผะฟัะปัััั ัะธััะตะผะธ ATLAS..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# ะะตัะตัะพะด ะฒ ะดะธัะตะบัะพัะธั goose
cd /Users/dev/Documents/GitHub/ATLAS/goose

# ะะบัะธะฒะฐัะธั ััะตะดั Hermit
echo "โ๏ธ  ะะบัะธะฒะฐััั ัะตัะตะดะพะฒะธัะฐ ัะพะทัะพะฑะบะธ Hermit..."
source bin/activate-hermit

if [ $? -ne 0 ]; then
    echo "โ ะะต ะฒะดะฐะปะพัั ะฐะบัะธะฒัะฒะฐัะธ Hermit ัะตัะตะดะพะฒะธัะต"
    exit 1
fi

echo "โ Hermit ัะตัะตะดะพะฒะธัะต ะฐะบัะธะฒะพะฒะฐะฝะพ"

## ---------------- AI Agent (goosed) build ----------------
# ะะตะถะธะผ ัะฑะพัะบะธ (ะผะพะถะฝะพ ะฟะตัะตะพะฟัะตะดะตะปะธัั: export GOOSE_BUILD_MODE=debug)
BUILD_MODE=${GOOSE_BUILD_MODE:-release}
[ "$BUILD_MODE" = "debug" ] && BUILD_FLAG="" || BUILD_FLAG="--release"
GOOSED_PATH="target/${BUILD_MODE}/goosed"

echo "๐ ะะฑัะฐะฝะพ build mode: ${BUILD_MODE} (ะฑัะฝะฐัะฝะธะน ัะฐะนะป: ${GOOSED_PATH})"

# ะัะธััะบะฐ ะฟัะตะดัะดััะตะน ัะฑะพัะบะธ (ะพะฟัะธะพะฝะฐะปัะฝะพ)
if [ "$1" = "--clean" ]; then
    echo "๐งน ะัะธัะตะฝะฝั ะฟะพะฟะตัะตะดะฝัะพั ะทะฑััะบะธ..."
    cargo clean
    echo "โ ะัะธัะตะฝะฝั ะทะฐะฒะตััะตะฝะพ"
fi

# ะะพะผะฟะธะปััะธั AI Agent ัะตัะฒะตัะฐ
echo "๐จ ะะพะผะฟัะปัััั AI Agent ัะตัะฒะตัะฐ (cargo build ${BUILD_FLAG} -p goose-server)..."
echo "   ะฆะต ะผะพะถะต ะทะฐะนะฝััะธ ะบัะปัะบะฐ ัะฒะธะปะธะฝ..."

# ะะพะบะฐะทัะฒะฐะตะผ ะฒัะตะผั ะฝะฐัะฐะปะฐ ัะฑะพัะบะธ
START_TIME=$(date)
echo "   โฐ ะะพัะฐัะพะบ: $START_TIME"

cargo build ${BUILD_FLAG} -p goose-server

BUILD_EXIT_CODE=$?

# ะะพะบะฐะทัะฒะฐะตะผ ะฒัะตะผั ะพะบะพะฝัะฐะฝะธั ัะฑะพัะบะธ
END_TIME=$(date)
echo "   โฐ ะะฐะฒะตััะตะฝะพ: $END_TIME"

if [ $BUILD_EXIT_CODE -ne 0 ]; then
    echo "โ ะะพะผะธะปะบะฐ ะบะพะผะฟัะปัััั AI Agent ัะตัะฒะตัะฐ"
    echo "๐ก ะกะฟัะพะฑัะนัะต:"
    echo "   1. ะะตัะตะฒััะธัะธ ะฝะฐัะฒะฝัััั ะฝะตะพะฑััะดะฝะธั ะทะฐะปะตะถะฝะพััะตะน"
    echo "   2. ะะฐะฟัััะธัะธ ะท ะพัะธัะตะฝะฝัะผ: ./build_atlas.sh --clean"
    echo "   3. ะะตัะตะฒััะธัะธ ะปะพะณะธ ะฒะธัะต ะดะปั ะดะตัะฐะปะตะน ะฟะพะผะธะปะบะธ"
    exit 1
fi

# ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั ัะบะพะผะฟะธะปะธัะพะฒะฐะฝะฝะพะณะพ ะฑะธะฝะฐัะฝะพะณะพ ัะฐะนะปะฐ
if [ ! -f "${GOOSED_PATH}" ]; then
    echo "โ ะัะฝะฐัะฝะธะน ัะฐะนะป ะฝะต ะทะฝะฐะนะดะตะฝะพ ะฟััะปั ะทะฑััะบะธ: ${GOOSED_PATH}"
    echo "๐ ะะผััั ะดะธัะตะบัะพััั target/${BUILD_MODE}:"
    ls -al target/${BUILD_MODE} 2>/dev/null || echo "   ะะธัะตะบัะพััั ะฝะต ััะฝัั"
    exit 1
fi

# ะะตะปะฐะตะผ ัะฐะนะป ะธัะฟะพะปะฝัะตะผัะผ
chmod +x "${GOOSED_PATH}" 2>/dev/null || true

# ะะพะปััะฐะตะผ ัะฐะทะผะตั ัะฐะนะปะฐ
FILE_SIZE=$(ls -lh "${GOOSED_PATH}" | awk '{print $5}')

echo "โ AI Agent ัะตัะฒะตั ััะฟััะฝะพ ัะบะพะผะฟัะปัะพะฒะฐะฝะพ!"
echo "   ๐ ะะพะทัะฐััะฒะฐะฝะฝั: ${GOOSED_PATH}"
echo "   ๐ ะะพะทะผัั ัะฐะนะปั: ${FILE_SIZE}"

# ะัะพะฒะตัะบะฐ ะฒะตััะธะธ ัะบะพะผะฟะธะปะธัะพะฒะฐะฝะฝะพะณะพ goose
echo "๐ ะะตัะตะฒััะบะฐ ะฒะตัััั ัะบะพะผะฟัะปัะพะฒะฐะฝะพะณะพ Goose..."
if "./${GOOSED_PATH}" --version > /dev/null 2>&1; then
    VERSION_INFO=$("./${GOOSED_PATH}" --version 2>/dev/null || echo "ะฒะตัััั ะฝะตะดะพัััะฟะฝะฐ")
    echo "   ๐ ะะตัััั: ${VERSION_INFO}"
else
    echo "   โ๏ธ ะะต ะฒะดะฐะปะพัั ะพััะธะผะฐัะธ ะฒะตัััั (ัะต ะฝะพัะผะฐะปัะฝะพ ะดะปั ะดะตัะบะธั ะทะฑััะพะบ)"
fi

# ะขะฐะบะถะต ะบะพะผะฟะธะปะธััะตะผ goose CLI ะตัะปะธ ะฝัะถะฝะพ
if [ "$2" = "--with-cli" ] || [ "$1" = "--with-cli" ]; then
    echo ""
    echo "๐จ ะะพะผะฟัะปัััั Goose CLI..."
    cargo build ${BUILD_FLAG} -p goose
    
    if [ $? -eq 0 ]; then
        CLI_PATH="target/${BUILD_MODE}/goose"
        chmod +x "${CLI_PATH}" 2>/dev/null || true
        CLI_SIZE=$(ls -lh "${CLI_PATH}" | awk '{print $5}')
        echo "โ Goose CLI ััะฟััะฝะพ ัะบะพะผะฟัะปัะพะฒะฐะฝะพ!"
        echo "   ๐ ะะพะทัะฐััะฒะฐะฝะฝั: ${CLI_PATH}"
        echo "   ๐ ะะพะทะผัั ัะฐะนะปั: ${CLI_SIZE}"
    else
        echo "โ๏ธ ะะพะผะธะปะบะฐ ะบะพะผะฟัะปัััั Goose CLI (ะฝะต ะบัะธัะธัะฝะพ ะดะปั ัะพะฑะพัะธ ัะธััะตะผะธ)"
    fi
fi

echo ""
echo "๐ ะะะะะะะฏะฆะะฏ ATLAS ะะะะะะจะะะ!"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ AI Agent Server ะณะพัะพะฒะธะน ะดะพ ะทะฐะฟััะบั"
echo "๐ก ะะปั ะทะฐะฟััะบั ัะธััะตะผะธ ะฒะธะบะพะฝะฐะนัะต: ./start_atlas.sh"
echo ""
echo "๐ ะะะะะกะะ ะะะะะะะ:"
echo "   ๐จ ะะตัะตะบะพะผะฟัะปัััั:        ./build_atlas.sh"
echo "   ๐งน ะัะธัะตะฝะฝั + ะบะพะผะฟัะปัััั: ./build_atlas.sh --clean"
echo "   ๐๏ธ ะ CLI ัะฝััััะผะตะฝัะฐะผะธ:   ./build_atlas.sh --with-cli"
echo "   ๐ ะะฐะฟััะบ ัะธััะตะผะธ:       ./start_atlas.sh"
echo ""
