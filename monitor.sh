#!/bin/bash

# ATLAS System Monitor Script
# Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ¼Ğ¾Ğ½Ñ–Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ñƒ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ¸ ATLAS
# Ğ’Ñ–Ğ´ÑÑ‚ĞµĞ¶ÑƒÑ” ÑÑ‚Ğ°Ğ½ Ğ²ÑÑ–Ñ… ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ–Ğ² Ñ– Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ” Ñ—Ñ… Ğ¿Ñ€Ğ°Ñ†ĞµĞ·Ğ´Ğ°Ñ‚Ğ½Ñ–ÑÑ‚ÑŒ

# Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ ĞºĞ¾Ğ»ÑŒĞ¾Ñ€Ñ–Ğ² Ğ´Ğ»Ñ Ğ²Ğ¸Ğ²ĞµĞ´ĞµĞ½Ğ½Ñ
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Ğ¤ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ´Ğ»Ñ Ğ²Ñ–Ğ´Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºÑƒ
print_header() {
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${CYAN}ğŸ” ATLAS Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ ĞœĞĞĞ†Ğ¢ĞĞ Ğ˜ĞĞ“Ğ£ - ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ ĞºĞ¾Ğ¶Ğ½Ñ– 5 ÑĞµĞºÑƒĞ½Ğ´${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
}

# Ğ¤ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ¸ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑƒ
check_process() {
    local process_name=$1
    local process_pattern=$2
    local port=$3
    local pid=$(pgrep -f "$process_pattern" | head -1)
    
    echo -n -e "${CYAN}$process_name:${NC} "
    
    if [ -z "$pid" ]; then
        echo -e "${RED}ĞĞµ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾${NC}"
        return 1
    else
        # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ CPU Ñ– Ğ¿Ğ°Ğ¼'ÑÑ‚Ñ–
        local cpu=$(ps -p $pid -o %cpu | tail -1 | tr -d ' ')
        local mem=$(ps -p $pid -o %mem | tail -1 | tr -d ' ')
        local runtime=$(ps -p $pid -o etime | tail -1 | tr -d ' ')
        
        echo -n -e "${GREEN}ĞŸÑ€Ğ°Ñ†ÑÑ” (PID: $pid)${NC}"
        echo -n -e " | CPU: $cpu% | MEM: $mem% | Ğ§Ğ°Ñ Ñ€Ğ¾Ğ±Ğ¾Ñ‚Ğ¸: $runtime"
        
        # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Ğ¿Ğ¾Ñ€Ñ‚Ñƒ, ÑĞºÑ‰Ğ¾ Ğ²ĞºĞ°Ğ·Ğ°Ğ½Ğ¾
        if [ ! -z "$port" ]; then
            if lsof -i:$port -P -n | grep LISTEN > /dev/null; then
                echo -n -e " | ${GREEN}ĞŸĞ¾Ñ€Ñ‚ $port: Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ğ¾${NC}"
            else
                echo -n -e " | ${RED}ĞŸĞ¾Ñ€Ñ‚ $port: Ğ·Ğ°ĞºÑ€Ğ¸Ñ‚Ğ¾${NC}"
            fi
        fi
        
        echo ""
        return 0
    fi
}

# Ğ¤ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ¸ Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²'Ñ API
check_health() {
    local url=$1
    local name=$2
    
    echo -n -e "${CYAN}$name API:${NC} "
    
    local response=$(curl -s -o /dev/null -w "%{http_code}" $url 2>/dev/null)
    
    if [ "$response" = "200" ]; then
        echo -e "${GREEN}OK (HTTP 200)${NC}"
    else
        echo -e "${RED}ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° (HTTP $response)${NC}"
    fi
}

# Ğ¤ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ´Ğ»Ñ Ğ²Ñ–Ğ´Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ¾ÑÑ‚Ğ°Ğ½Ğ½Ñ–Ñ… Ğ»Ğ¾Ğ³Ñ–Ğ²
show_last_logs() {
    local log_file=$1
    local component=$2
    local lines=${3:-5}
    
    echo -e "${CYAN}ĞÑÑ‚Ğ°Ğ½Ğ½Ñ– Ğ»Ğ¾Ğ³Ğ¸ $component:${NC}"
    echo -e "${BLUE}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    
    if [ -f "$log_file" ]; then
        tail -$lines "$log_file" | while read -r line; do
            if [[ $line == *"error"* ]] || [[ $line == *"Error"* ]] || [[ $line == *"ERROR"* ]] || [[ $line == *"âŒ"* ]]; then
                echo -e "${RED}$line${NC}"
            elif [[ $line == *"warning"* ]] || [[ $line == *"Warning"* ]] || [[ $line == *"WARNING"* ]] || [[ $line == *"âš ï¸"* ]]; then
                echo -e "${YELLOW}$line${NC}"
            else
                echo "$line"
            fi
        done
    else
        echo -e "${RED}Ğ¤Ğ°Ğ¹Ğ» Ğ»Ğ¾Ğ³Ñƒ Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾: $log_file${NC}"
    fi
    
    echo -e "${BLUE}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
}

# ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¸Ğ¹ Ñ†Ğ¸ĞºĞ» Ğ¼Ğ¾Ğ½Ñ–Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ñƒ
while true; do
    clear
    print_header
    
    # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ²
    echo -e "${CYAN}Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ–Ğ²:${NC}"
    echo -e "${BLUE}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    check_process "ğŸ¤– AI Agent" "goosed" "3000"
    check_process "ğŸŒ Frontend" "atlas_minimal" "8080"
    check_process "ğŸ—£ï¸ TTS Server" "mcp_tts" ""
    echo -e "${BLUE}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    
    # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° API
    echo -e "${CYAN}Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ API:${NC}"
    echo -e "${BLUE}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    check_health "http://localhost:3000/health" "AI Agent"
    check_health "http://localhost:8080" "Frontend"
    echo -e "${BLUE}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    
    # ĞÑÑ‚Ğ°Ğ½Ğ½Ñ– Ğ»Ğ¾Ğ³Ğ¸ AI Agent
    show_last_logs "/tmp/goose.log" "AI Agent"
    
    # ĞÑÑ‚Ğ°Ğ½Ğ½Ñ– Ğ»Ğ¾Ğ³Ğ¸ TTS
    show_last_logs "/tmp/tts.log" "TTS Server"
    
    # ĞÑÑ‚Ğ°Ğ½Ğ½Ñ– Ğ»Ğ¾Ğ³Ğ¸ Frontend
    show_last_logs "/tmp/frontend.log" "Frontend"
    
    echo -e "${YELLOW}ĞĞ°Ñ‚Ğ¸ÑĞ½Ñ–Ñ‚ÑŒ Ctrl+C Ğ´Ğ»Ñ Ğ²Ğ¸Ñ…Ğ¾Ğ´Ñƒ. ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ñ‡ĞµÑ€ĞµĞ· 5 ÑĞµĞº...${NC}"
    sleep 5
done
