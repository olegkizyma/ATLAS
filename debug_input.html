<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas Input Debugger</title>
    <style>
        body { font-family: monospace; background: #000; color: #00ff41; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #00ff41; border-radius: 5px; }
        .status { padding: 5px; margin: 5px 0; border-left: 3px solid #00ff41; padding-left: 10px; }
        .error { border-left-color: #ff0000; color: #ff6666; }
        .success { border-left-color: #00ff00; color: #66ff66; }
        .warning { border-left-color: #ffaa00; color: #ffcc66; }
        button { 
            background: #003300; color: #00ff41; border: 1px solid #00ff41; 
            padding: 8px 15px; margin: 5px; cursor: pointer; border-radius: 3px; 
        }
        button:hover { background: #005500; }
        .log { 
            background: #001100; border: 1px solid #003300; padding: 10px; 
            height: 300px; overflow-y: auto; margin-top: 10px; 
        }
        .input-test { padding: 10px; border: 1px solid #00ff41; margin: 10px 0; }
        input, textarea { 
            background: #000; color: #00ff41; border: 1px solid #00ff41; 
            padding: 5px; width: 100%; margin: 5px 0; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Atlas Input Field Debugger</h1>
        
        <div class="section">
            <h2>üìä System Status</h2>
            <div id="systemStatus">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
            <button onclick="checkSystemStatus()">üîÑ –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å</button>
        </div>
        
        <div class="section">
            <h2>üéØ Input Field Status</h2>
            <div id="inputStatus">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞...</div>
            <button onclick="checkInputField()">üîç –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø–æ–ª–µ –≤–≤–æ–¥—É</button>
            <button onclick="forceUnlockInput()">üîì –ü—Ä–∏–º—É—Å–æ–≤–æ —Ä–æ–∑–±–ª–æ–∫—É–≤–∞—Ç–∏</button>
            <button onclick="resetAllFlags()">üîÑ –°–∫–∏–Ω—É—Ç–∏ –≤—Å—ñ –ø—Ä–∞–ø–æ—Ä—Ü—ñ</button>
        </div>
        
        <div class="section">
            <h2>üß™ Test Input Field</h2>
            <div class="input-test">
                <textarea id="testInput" placeholder="–í–≤–µ–¥—ñ—Ç—å —Ç–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." rows="3"></textarea>
                <button onclick="sendTestMessage()">üì§ –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ —Ç–µ—Å—Ç</button>
                <button onclick="simulateStreaming()">üì° –°–∏–º—É–ª—é–≤–∞—Ç–∏ —Å—Ç—Ä—ñ–º—ñ–Ω–≥</button>
            </div>
        </div>
        
        <div class="section">
            <h2>üîß Emergency Tools</h2>
            <button onclick="emergencyReset()">üö® –ê–≤–∞—Ä—ñ–π–Ω–∏–π —Å–∫–∏–¥</button>
            <button onclick="reloadInterface()">üîÑ –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å</button>
            <button onclick="clearLogs()">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ –ª–æ–≥–∏</button>
        </div>
        
        <div class="section">
            <h2>üìã Debug Log</h2>
            <div class="log" id="debugLog"></div>
        </div>
    </div>

    <script>
        let debugLog = document.getElementById('debugLog');
        let logCount = 0;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            debugLog.innerHTML += `<div class="status ${className}">[${timestamp}] ${message}</div>`;
            debugLog.scrollTop = debugLog.scrollHeight;
            logCount++;
            if (logCount > 200) {
                const lines = debugLog.innerHTML.split('</div>');
                debugLog.innerHTML = lines.slice(-100).join('</div>');
                logCount = 100;
            }
        }
        
        function getMainWindow() {
            // –°–ø—Ä–æ–±—É—î–º–æ –∑–Ω–∞–π—Ç–∏ –≥–æ–ª–æ–≤–Ω–µ –≤—ñ–∫–Ω–æ Atlas
            if (window.opener && window.opener.atlasInterface) return window.opener;
            if (window.parent && window.parent.atlasInterface) return window.parent;
            if (window.top && window.top.atlasInterface) return window.top;
            
            // –°–ø—Ä–æ–±—É—î–º–æ —á–µ—Ä–µ–∑ –ø–æ—Ä—Ç–∞–ª
            try {
                const atlasWindow = window.open('http://localhost:8080', 'atlas');
                if (atlasWindow && atlasWindow.atlasInterface) return atlasWindow;
            } catch (e) {}
            
            return null;
        }
        
        async function checkSystemStatus() {
            log('üîç –ü–µ—Ä–µ–≤—ñ—Ä—è—é —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º–∏...');
            try {
                const response = await fetch('http://localhost:8080/api/status');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('systemStatus').innerHTML = `
                        <div class="status success">‚úÖ Atlas Frontend: ${data.services?.atlas_frontend || 'unknown'}</div>
                        <div class="status success">‚úÖ Atlas Core: ${data.services?.atlas_core_available ? 'available' : 'unavailable'}</div>
                        <div class="status">üìä Processes: ${JSON.stringify(data.processes)}</div>
                        <div class="status">‚è∞ Timestamp: ${data.services?.timestamp}</div>
                    `;
                    log('‚úÖ –°–∏—Å—Ç–µ–º–Ω–∏–π —Å—Ç–∞—Ç—É—Å –æ—Ç—Ä–∏–º–∞–Ω–æ', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                document.getElementById('systemStatus').innerHTML = `<div class="status error">‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}</div>`;
                log(`‚ùå –ü–æ–º–∏–ª–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å—É: ${error.message}`, 'error');
            }
        }
        
        function checkInputField() {
            log('üéØ –ü–µ—Ä–µ–≤—ñ—Ä—è—é —Å—Ç–∞–Ω –ø–æ–ª—è –≤–≤–æ–¥—É...');
            const mainWindow = getMainWindow();
            
            if (!mainWindow || !mainWindow.atlasInterface) {
                const status = `
                    <div class="status error">‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ –≥–æ–ª–æ–≤–Ω–µ –≤—ñ–∫–Ω–æ Atlas</div>
                    <div class="status warning">‚ö†Ô∏è –í—ñ–¥–∫—Ä–∏–π—Ç–µ Atlas –≤ —ñ–Ω—à—ñ–π –≤–∫–ª–∞–¥—Ü—ñ: <a href="http://localhost:8080" target="_blank">http://localhost:8080</a></div>
                `;
                document.getElementById('inputStatus').innerHTML = status;
                log('‚ùå –ì–æ–ª–æ–≤–Ω–µ –≤—ñ–∫–Ω–æ Atlas –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'error');
                return;
            }
            
            const iface = mainWindow.atlasInterface;
            const input = mainWindow.document.getElementById('chatInput');
            
            const status = `
                <div class="status ${iface.isStreaming ? 'error' : 'success'}">üì° isStreaming: ${iface.isStreaming}</div>
                <div class="status ${iface.isStreamPending ? 'error' : 'success'}">‚è≥ isStreamPending: ${iface.isStreamPending}</div>
                <div class="status ${input?.disabled ? 'error' : 'success'}">üîê input.disabled: ${input?.disabled || 'not found'}</div>
                <div class="status ${iface._autoBlockedBySessions ? 'warning' : 'success'}">üîí _autoBlockedBySessions: ${iface._autoBlockedBySessions}</div>
                <div class="status">‚è∞ _lastStreamFinishedAt: ${iface._lastStreamFinishedAt ? new Date(iface._lastStreamFinishedAt).toLocaleTimeString() : 'never'}</div>
                <div class="status">üõ°Ô∏è _autoBlockGraceUntil: ${iface._autoBlockGraceUntil ? new Date(iface._autoBlockGraceUntil).toLocaleTimeString() : 'none'}</div>
            `;
            
            document.getElementById('inputStatus').innerHTML = status;
            
            if (input?.disabled || iface.isStreaming || iface.isStreamPending) {
                log('‚ö†Ô∏è –ü–æ–ª–µ –≤–≤–æ–¥—É –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ –∞–±–æ —Å—Ç—Ä—ñ–º –∞–∫—Ç–∏–≤–Ω–∏–π', 'warning');
            } else {
                log('‚úÖ –ü–æ–ª–µ –≤–≤–æ–¥—É –≤ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º—É —Å—Ç–∞–Ω—ñ', 'success');
            }
        }
        
        function forceUnlockInput() {
            log('üîì –ü—Ä–∏–º—É—Å–æ–≤–µ —Ä–æ–∑–±–ª–æ–∫—É–≤–∞–Ω–Ω—è –ø–æ–ª—è –≤–≤–æ–¥—É...');
            const mainWindow = getMainWindow();
            
            if (!mainWindow || !mainWindow.atlasInterface) {
                log('‚ùå –ì–æ–ª–æ–≤–Ω–µ –≤—ñ–∫–Ω–æ Atlas –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'error');
                return;
            }
            
            const iface = mainWindow.atlasInterface;
            const input = mainWindow.document.getElementById('chatInput');
            
            // –°–∫–∏–¥–∞—î–º–æ –≤—Å—ñ –ø—Ä–∞–ø–æ—Ä—Ü—ñ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è
            iface.isStreaming = false;
            iface.isStreamPending = false;
            iface._autoBlockedBySessions = false;
            
            // –†–æ–∑–±–ª–æ–∫–æ–≤—É—î–º–æ –ø–æ–ª–µ –≤–≤–æ–¥—É
            if (input) {
                input.disabled = false;
                log('‚úÖ –ü–æ–ª–µ –≤–≤–æ–¥—É –ø—Ä–∏–º—É—Å–æ–≤–æ —Ä–æ–∑–±–ª–æ–∫–æ–≤–∞–Ω–æ', 'success');
            } else {
                log('‚ùå –ü–æ–ª–µ –≤–≤–æ–¥—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'error');
            }
            
            // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å
            setTimeout(checkInputField, 100);
        }
        
        function resetAllFlags() {
            log('üîÑ –°–∫–∏–¥–∞–Ω–Ω—è –≤—Å—ñ—Ö –ø—Ä–∞–ø–æ—Ä—Ü—ñ–≤...');
            const mainWindow = getMainWindow();
            
            if (!mainWindow || !mainWindow.atlasInterface) {
                log('‚ùå –ì–æ–ª–æ–≤–Ω–µ –≤—ñ–∫–Ω–æ Atlas –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'error');
                return;
            }
            
            const iface = mainWindow.atlasInterface;
            
            // –ü–æ–≤–Ω–∏–π —Å–∫–∏–¥
            iface.isStreaming = false;
            iface.isStreamPending = false;
            iface._autoBlockedBySessions = false;
            iface.autoReplyActive = false;
            iface.TTS_ACTIVE = false;
            iface._lastStreamFinishedAt = Date.now();
            iface._autoBlockGraceUntil = 0;
            
            // –û—á–∏—â—É—î–º–æ —á–µ—Ä–≥–∏ —Ç–∞ —Ç–∞–π–º–µ—Ä–∏
            if (iface.messageQueue) iface.messageQueue.length = 0;
            if (iface.autoReplyTimer) {
                clearTimeout(iface.autoReplyTimer);
                iface.autoReplyTimer = null;
            }
            if (iface.TTSBlockTimer) {
                clearTimeout(iface.TTSBlockTimer);
                iface.TTSBlockTimer = null;
            }
            
            log('‚úÖ –í—Å—ñ –ø—Ä–∞–ø–æ—Ä—Ü—ñ —Å–∫–∏–Ω—É—Ç–æ', 'success');
            setTimeout(checkInputField, 100);
        }
        
        async function sendTestMessage() {
            const testInput = document.getElementById('testInput');
            const message = testInput.value.trim();
            
            if (!message) {
                log('‚ùå –í–≤–µ–¥—ñ—Ç—å —Ç–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è', 'error');
                return;
            }
            
            log(`üì§ –í—ñ–¥–ø—Ä–∞–≤–ª—è—é —Ç–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: "${message}"`);
            
            try {
                const response = await fetch('http://localhost:8080/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('‚úÖ –¢–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —É—Å–ø—ñ—à–Ω–æ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ', 'success');
                    log(`üì® –í—ñ–¥–ø–æ–≤—ñ–¥—å: ${data.atlas_processing?.response?.substring(0, 100) || JSON.stringify(data).substring(0, 100)}...`);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏: ${error.message}`, 'error');
            }
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞–Ω –ø—ñ—Å–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
            setTimeout(checkInputField, 1000);
        }
        
        function simulateStreaming() {
            log('üì° –°–∏–º—É–ª—é—é —Å—Ç—Ä—ñ–º—ñ–Ω–≥ –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è...');
            const mainWindow = getMainWindow();
            
            if (!mainWindow || !mainWindow.atlasInterface) {
                log('‚ùå –ì–æ–ª–æ–≤–Ω–µ –≤—ñ–∫–Ω–æ Atlas –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'error');
                return;
            }
            
            const iface = mainWindow.atlasInterface;
            const input = mainWindow.document.getElementById('chatInput');
            
            // –°–∏–º—É–ª—é—î–º–æ –ø–æ—á–∞—Ç–æ–∫ —Å—Ç—Ä—ñ–º—ñ–Ω–≥—É
            iface.isStreamPending = true;
            if (input) input.disabled = true;
            log('üîí –°–∏–º—É–ª—è—Ü—ñ—è: –ø–æ–ª–µ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ', 'warning');
            
            setTimeout(() => {
                iface.isStreamPending = false;
                iface.isStreaming = true;
                log('üì° –°–∏–º—É–ª—è—Ü—ñ—è: —Å—Ç—Ä—ñ–º—ñ–Ω–≥ –∞–∫—Ç–∏–≤–Ω–∏–π', 'warning');
            }, 1000);
            
            setTimeout(() => {
                // –°–∏–º—É–ª—é—î–º–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Å—Ç—Ä—ñ–º—ñ–Ω–≥—É
                iface.isStreaming = false;
                iface.isStreamPending = false;
                if (input) input.disabled = false;
                log('‚úÖ –°–∏–º—É–ª—è—Ü—ñ—è: —Å—Ç—Ä—ñ–º—ñ–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω–æ, –ø–æ–ª–µ —Ä–æ–∑–±–ª–æ–∫–æ–≤–∞–Ω–æ', 'success');
                checkInputField();
            }, 3000);
        }
        
        function emergencyReset() {
            log('üö® –ê–≤–∞—Ä—ñ–π–Ω–∏–π —Å–∫–∏–¥ —Å–∏—Å—Ç–µ–º–∏...');
            resetAllFlags();
            forceUnlockInput();
            
            // –î–æ–¥–∞—Ç–∫–æ–≤–∏–π —Å–∫–∏–¥ —á–µ—Ä–µ–∑ DOM
            try {
                const mainWindow = getMainWindow();
                if (mainWindow) {
                    const input = mainWindow.document.getElementById('chatInput');
                    if (input) {
                        input.disabled = false;
                        input.style.opacity = '1';
                        input.style.pointerEvents = 'auto';
                        input.removeAttribute('readonly');
                    }
                }
            } catch (e) {
                log(`‚ö†Ô∏è –î–æ–¥–∞—Ç–∫–æ–≤–∏–π DOM —Å–∫–∏–¥ –Ω–µ –≤–¥–∞–≤—Å—è: ${e.message}`, 'warning');
            }
            
            log('üö® –ê–≤–∞—Ä—ñ–π–Ω–∏–π —Å–∫–∏–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–æ', 'success');
        }
        
        function reloadInterface() {
            log('üîÑ –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É Atlas...');
            const mainWindow = getMainWindow();
            if (mainWindow) {
                mainWindow.location.reload();
                log('‚úÖ –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è...', 'success');
            } else {
                window.open('http://localhost:8080', '_blank');
                log('üìñ –í—ñ–¥–∫—Ä–∏–≤–∞—é –Ω–æ–≤–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å...', 'success');
            }
        }
        
        function clearLogs() {
            debugLog.innerHTML = '';
            logCount = 0;
            log('üßπ –õ–æ–≥–∏ –æ—á–∏—â–µ–Ω–æ');
        }
        
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
        window.addEventListener('DOMContentLoaded', () => {
            log('üîß Atlas Input Debugger –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ');
            checkSystemStatus();
            setTimeout(checkInputField, 500);
            
            // –ê–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–∂–Ω—ñ 10 —Å–µ–∫—É–Ω–¥
            setInterval(checkInputField, 10000);
        });
        
        // –ì–∞—Ä—è—á–∞ –∫–ª–∞–≤—ñ—à–∞ F5 –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
        window.addEventListener('keydown', (e) => {
            if (e.key === 'F5') {
                e.preventDefault();
                checkSystemStatus();
                checkInputField();
            }
        });
    </script>
</body>
</html>
